process help=*
PARM INP TYPE=STRING COUNT=2
PARM OUT TYPE=STRING COUNT=2
PARM OPTION    TYPE=INTEGER COUNT=(1:2) DEFAULT=1
PARM FTOL TYPE=REAL COUNT=1 DEFAULT=.0001
PARM INERTIA TYPE=REAL COUNT=1 DEFAULT=0
END-PROC

.TITLE
VICAR program MARSBIAS

.HELP

NOTE
====
THIS PROGRAM IS NOW OBSOLETE.  Please use MARSBRT instead.

PURPOSE:
Computes the mosaic intensity BIAS parameters from the overlap file 
generated by program MARSINT. This file contains the intensity correction
factors required to make images in a mosaic match in intensity.

The bias.txt file can be input to the mars mosaicking programs to
replace the BIAS parameter (only multiplicative).

The script.pdf file is an executable vicar pdf file which can be run
to convert all the images in listoffiles into images in the local
directory. These local images are named p001.img, p002.img etc and
they have been run through marsrad and f2 to correct for brightness.

EXAMPLE:
(For shell vicar only. The final mosaic is generated by the last step)
marsint inp=listoffiles out=\(mosaic.img,overlap.txt\) zoom=.2
marsbias in=\(listoffiles,overlap.txt\) out=\(bias.txt,script.pdf\)
marsmap inp=listoffiles out=mosaic.img zoom=.1 bias=\(` cat bias.txt`\)
    
METHOD:
Marsbias determines a set of multiplicative or additive constants which,
when applied to the input images, result in minimizing the brightness 
differences between these images in the mosaic. This is normally done by
decalibrating the images and dividing the images by the exposure time. 


Multiplicative:
Minimizes the sums of all combinations of overlap areas taken 2 at a time.
sum(overlaps)sum(pairs) (1-bias(i)*dn(i)/bias(j)*dn(j))

Additive:
Minimizes the sums of all combinations of overlap areas taken 2 at a time.
sum(overlaps)sum(pairs) ((bias(i)+dn(i))-(bias(j)+dn(j)))

Images with no overlaps are assigend a no-op bias (multiplicative of 1.0,
additive of 0.0).

An INERTIA value modifies the cost function by adding in the difference of
the bias from a no-op, times the inertia.  This provides a "stay-in-place"
weighting, causing the solution to preferentially stay near where it started.
Selecting values for this is trial-and-error and it should usually be 0.

HISTORY:
12-10-2003 J Lorre. 
10-2006 (rgd) Added INERTIA, and no-op bias for unconnected images.

COGNIZANT PROGRAMMER:  Bob Deen

.LEVEL1
.VARI INP
1 listoffiles
2 input overlap file

.VARI OUT
1 output bias factors
2 vicar script pdf

.VARI OPTION
1=multiplicative
2=additive

.VARI FTOL
Tolerance value for amoeba

.VARI INERTIA
Inertia value

.LEVEL2
.VARI INP
1 listoffiles
2 input overlap file

.VARI OUT
1 output bias factors, ascii, one per record.
2 vicar script to run marsrad and f2 to correct the image intensities.
 
.VARI OPTION
1=multiplicative correction (default)
2=additive correction

.VARI FTOL
Tolerance value for amoeba.  Specifies how accurate the answer should be.
Smaller numbers usually make for a better solution, but can increase the
runtime significantly.

.VARI INERTIA
An INERTIA value modifies the cost function by adding in the difference of
the bias from a no-op, times the inertia.  This provides a "stay-in-place"
weighting, causing the solution to preferentially stay near where it started.
Selecting values for this is trial-and-error and it should usually be 0.

