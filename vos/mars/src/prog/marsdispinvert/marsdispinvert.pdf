process help=*
PARM INP TYPE=STRING COUNT=2
PARM OUT TYPE=STRING COUNT=1
PARM IN_DISP TYPE=STRING COUNT=1
PARM S_FILL_VALUE TYPE=REAL COUNT=0:1 DEFAULT=--
PARM L_FILL_VALUE TYPE=REAL COUNT=0:1 DEFAULT=--
PARM DISP_PYRAMID TYPE=INTEGER COUNT=1 DEFAULT=0

PARM POINT_METHOD TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM DATA_SET_NAME TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM DATA_SET_ID TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM RELEASE_ID TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM PRODUCT_ID TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM PRODUCER_ID TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM PRODUCER_INST TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM TARGET_NAME TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM TARGET_TYPE TYPE=STRING COUNT=(0:1) DEFAULT=--

END-PROC 

.TITLE
VICAR program DISP_INVERT
.HELP
PURPOSE:

This program takes a disparity map, such as generated by marscor3 or
marsjplstereo, and "inverts" it, or flips the eyes.  That is, if the
input disparity map is in the left eye geometry giving coordinates of
matching pixels in the right eye, the output will be a disparity map
in the right eye geometry giving coordinates of matching pixels in the
left eye.

Missing values in the inverted disparity image
(both line and sample values) will be filled in if both 
of the parameters s_fill_value and l_fill_value are given.
These values are  best guess values, perhaps determined by inspection.
This is useful because a pixels in a disparity image are ignored by 
the program marscor3 if the pixel value is 0.

The intent of this is to enable use of marsjplstereo (perhaps combined
with marsunlinearize) to generate seeds for marscor3.  The 1-D correlator
at the heart of marsjpstereo only likes generating positive disparities
(which result in L->R correlations on MER).  Doing a R->L correlation
requires negative disparities, which the 1-D correlator cannot do.
This program will take the L->R correlation and produce an equivalent
R->L disparity map.

It is NOT recommended that the result of this program be used directly.
It should be used only as a seed file for something like marscor3.
The reason is that this is not an entirely invertible operation.  If
two pixels in the input map to the same pixel in the output, only one
of those pixels will be represented (officially indeterminate, but most
likely the last one encountered in scanline order).  Also, no attempt
is made to preserve subpixel disparity values: the output will be all
integer disparities.

Note that the disparity files must be single two-band files.  Separate
line and sample disparities, while acceptable to most correlator programs,
are not supported in this program.

Note on forwarding extra correlation information:
Starting with M2020, correlation file labels contain some extra information
(number of valid pixel, average scale difference between L/R, and percentage
of overlap between L/R). This information is forwarded to the inverted 
disparity file the following way:
- Number of valid pixels: Simple counter of the valid pixels in the input
disparity map which have been successfully "inverted". 
- Average scale difference: 1/input disparity average scale difference
- Percentage of overlap between L/R: ratio between number of valid inverted 
pixels and total number of pixels of the inverted disparity image. Note that 
this value could differ significantly from the input disparity percentage of 
overlap even if the L/R image fov is about the same. The reason being that the 
input disparity might contain an "estimate" of the overlap (defined from the
cam geometry only, i.e., pre-correlation), whereas the inverted disparity 
contains the actual overlap w.r.t. to valid pixels. 

EXECUTION:

marsjplstereo inp=(left,right) out=disp1d.lr
marsdispinvert inp=(right, left) out=disp1d.rl in_disp=disp1d.lr
marscor3 inp=(right,left) out=disp2d.rl in_disp=disp1d.rl

The program can also handle pyramid (downsampled) disparity maps, by
specifying the disp_pyr pyramid level (note that this only changes the
output size; the results are otherwise identical).  The pyramid level cannot
be changed by this program.

marsjplstereo (left,right) disp1d.lr pyramid=1
marsdispinvert (right, left) disp1d.rl in_disp=disp1d.lr disp_pyr=1
marscor3 inp=(right,left) out=disp2d.rl in_disp=disp1d.rl disp_pyr=1

OPERATION:

The process works by looping over the disparity map.  For each pixel (i,j),
the value of the disparity map is retrieved.  This represents the location
of the corresponding pixel in the right image (i',j').  This value is rounded
off to integers.  The disparity map for the right image at (i',j') is then
filled with the value (i,j) to represent the backwards mapping.

HISTORY:
July 05		Initial version by Bob Deen
Sept 09         Minor modification (added fill values)by Mathew Yeates
Sept 11         Changed input parameters to generated proper label -Oleg Pariser
Oct  13		Modified to work for different-size images; added disp_pyr
Aug  20		Forwarding of extra correlation information

.LEVEL1
.VARI INP
input images.
Used only for Label purposes.

.VARI OUT
Output inverted disparity image

.VARI IN_DISP
Input disparity
file.

.VARI S_FILL_VALUE
Default value for the inverted
disparity sample values.

.VARI L_FILL_VALUE
Default value for the inverted
disparity line values.

.VARI DISP_PYRAMID
Pyramid level of
input disparities

.VARI POINT_METHOD
Specifies a mission-
specific pointing
method to use

.VARI DATA_SET_NAME
Specifies the full name given
to a data set or a data product.

.VARI DATA_SET_ID
Specifies a unique alphanumeric
identifier for a data set or data
product.

.VARI RELEASE_ID
Specifies the unique identifier
associated with the release to the
public of all or part of a data set.
The release number is associated with
the data set, not the mission.

.VARI PRODUCT_ID
Specifies a permanent, unique
identifier assigned to a data
product by its producer.

.VARI PRODUCER_ID
Specifies the unique identifier
of an entity associated with the
production a data set.

.VARI PRODUCER_INST
Specifies the full name of the
identity of an entity associated
with the production of a data set.

.VARI TARGET_NAME
Specifies a target.

.VARI TARGET_TYPE
Specifies the type of a named target.

.LEVEL2
.VARI INP
Pair of input images used only for populating output label properly.
First input is the primary one and is the basis of the output label.
Note that if you are inverting L -> R then the inputs should be in the
order (R, L).

The size of the output is determined by first INP, as modified by DISP_PYRAMID.

.VARI OUT
Output inverted disparity image.  It is derived from IN_DISP input.
Will be a single 2-band file.

.VARI IN_DISP
Input disparity image.  See the correlator programs for a description of
the format.  Must be a single 2-band file.

.VARI S_FILL_VALUE
Default delta value for the inverted disparity sample values.

.VARI L_FILL_VALUE
Default delta value for the inverted disparity line  values.

.VARI DISP_PYRAMID
Specifies the pyramid level of the input disparities.  This must match what
was specified in PYRLEVEL when the disparities were created (e.g. in
marsjplstereo, marsfakedisp, or marscor3).

.VARI POINT_METHOD
Specifies a mission-specific pointing method to use.  Normally this
parameter is not used, in which case the "default" pointing methods
are used.  Some missions may have special, or alternate, pointing
methods available, which are indicated by this string (for example,
backlash models, using arm joint angles instead of x/y/z/az/el, etc).
A substring search is used, so multiple methods (where that makes sense)
can be specified by separating the keywords with commas.

See the help for other programs (notably marsmap) for potential values
for this parameter.  It has little use for marsdispinvert but is included
for completeness.

.VARI DATA_SET_NAME
The DATA_SET_NAME typically identifies the instrument that acquired the
data, the target of that instrument, and the processing level of the data.
This value is copied to the output label, property IDENTIFICATION,
keyword DATA_SET_NAME.

.VARI DATA_SET_ID
The DATA_SET_ID value for a given data set or product is constructed
according to flight project naming conventions.  In most cases the
DATA_SET_ID is an abbreviation of the DATA_SET_NAME.
This value is copied to the output label, property IDENTIFICATION,
keyword DATA_SET_ID.

.VARI RELEASE_ID
When a data set is released incrementally, such as every three months during
a mission, the RELEASE_ID is updated each time part of the data set is released.
For each mission(or host id if multiple spacecrafts), the first release of a data
set should have a value of "0001".
This value is copied to the output label, property IDENTIFICATION,
keyword RELEASE_ID.

.VARI PRODUCT_ID
Specifies a permanent, unique identifier assigned to a data product by
its producer. Most commonly, it is the filename minus the extension.
This value is copied to the output label, property IDENTIFICATION,
keyword PRODUCT_ID.

.VARI PRODUCER_ID
Specifies the unique identifier of an entity associated with the
production of a data set. This value is copied to the output label,
property IDENTIFICATION, keyword PRODUCER_ID.

.VARI PRODUCER_INST
Specifies the identity of a university, research center, NASA center or other
institution associated with the production of a data set.
This value is copied to the output label, property IDENTIFICATION, keyword
PRODUCER_INSTITUTION_NAME.

.VARI TARGET_NAME
Specifies a target.  The target may be a planet, satelite, ring, region, feature,
asteroid or comet.  This value is copied to the output label, property
IDENTIFICATION, keyword TARGET_NAME.

.VARI TARGET_TYPE
Specifies the type of a named target. This value is copied to the output
label, property IDENTIFICATION, keyword TARGET_NAME.


