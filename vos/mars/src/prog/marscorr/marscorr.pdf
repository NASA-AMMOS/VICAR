process help=*
PARM INP TYPE=STRING COUNT=2
PARM OUT TYPE=STRING COUNT=(1:2)
PARM MASK TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM OUT_QUALITY TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM BAND    TYPE=INTEGER COUNT=(0:1) DEFAULT=1
PARM TEMPLATE TYPE=INTEGER COUNT=(0:2) DEFAULT=15
PARM SEARCH TYPE=INTEGER COUNT=(0:2) DEFAULT=35
PARM QUALITY TYPE=REAL COUNT=(0:1) DEFAULT=.6
PARM TPTLIMIT  TYPE=INTEGER COUNT=(0:1) DEFAULT=-1
PARM SEED TYPE=INTEGER COUNT=(4) DEFAULT=(124,127,126,108)
PARM SEEDFILE TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM SEEDPAIR TYPE=INTEGER COUNT=2 DEFAULT=(0,1)
PARM AMAX TYPE=INTEGER COUNT=(0:2) DEFAULT=(31,81)
PARM MODE TYPE=KEYWORD COUNT=1 VALID=("linear", "annealing", "amoeba", +
	 "linear_amoeba", "annealing_amoeba", "amoeba2", "linear_amoeba2") +
	DEFAULT="amoeba"

PARM DATA_SET_NAME TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM DATA_SET_ID TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM RELEASE_ID TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM PRODUCT_ID TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM PRODUCER_ID TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM PRODUCER_INST TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM TARGET_NAME TYPE=STRING COUNT=(0:1) DEFAULT=--
PARM TARGET_TYPE TYPE=STRING COUNT=(0:1) DEFAULT=--

END-PROC

.TITLE
VICAR program MARSCORR.

.HELP
PURPOSE:
To compute, from a stereo pair of images, the line and sample disparity
of every pixel in the scene.  The output is typically run through the
program MARSXYZ to generate X,Y,Z coordinates over the entire image.

This is a general-purpose correlation program, which does not make use of
any pointing or camera model information.  The input images do not have to
be registered or epipolar aligned, as long as appropriate seed point(s) are
provided.

This program is derived from Mars Pathfinder's MPFTPT.

EXECUTION:
marscorr inp=(left,right) out=(line_disparity,samp_disparity) mask=mask params

where:
left is the left eye image of a stereo pair
right is the corresponding right eye image of a stereo pair
line_disparity is the right eye line value, for each pixel in the left image.
samp_disparity is the right eye sample value, for each pixel in the left image.
mask is a completion status.  

Although "left" and "right" are used above, there is no actual restriction
that the first image be left and the second be right.  Correlations are done
from the first image to the second.  Output images (disparity and mask)
correspond to the first image, containing matching coordinates in the second
image.  However, for convenience, "left" and "right" are used throughout
this help.

Additionally, out_quality can be used to name an output file which will
contain the correlation qualities for each pixel.
.PAGE

METHOD:
A seed point is used as an initial guess to obtain an initial correlation,
using a wide search area (defined by AMAX(2)).  A region is grown from the
seed outward in a spiral-like pattern until the picture is filled.

For each pixel, the 8 neighbors are examined to find the one with the best
correlation value so far.  This neighbor is used as the initial guess for
the pixel in question (modified +/-1 as appropriate).  If no correlated
neighbors are found, the pixel is skipped.  The correlation window is
defined via the TEMPLATE and SEARCH parameters.

Once the region has grown to the size of the image (or TPTLIMIT pixels have
been correlated), a second pass goes through the region and attempts to
fill gores, or pixels that did not correlate on the first pass, by again
examining all of its neighbors (since neighbors on the other side, which
were not done previously, might provide a better starting location, which
will correlate, especially near edges).  This process continues until no
more gores are filled in a pass.

If an input tiepoint file (generated by MARSTIE) was provided, the tiepoints
in that file are used as multiple seeds.  The entire process above is repeated
in turn for each seed.  If a seed point has already been correlated via a
region grown from a previous seed, the new seed is ignored.  Multiple seed
points are good for areas separated from the rest of the image by large
disparity displacements or uncorrelateable areas such as undifferentiated
sand.

All correlations are performed using the gruen correlation routine.  See
the gruen documentation for details of the algorithm.  Seed points are
always correlated using mode 3 (linear followed by amoeba) to handle large
offsets.  The rest of the points may be correlated using any gruen mode
via the MODE parameter:

linear:            gruen mode 0
annealing:         gruen mode 1
amoeba:            gruen mode 2
linear_amoeba:     gruen mode 3
annealing_amoeba:  gruen mode 4
amoeba2:           gruen mode 5
linear_amoeba2:    gruen mode 6

Of the above, only amoeba and amoeba2 (modes 2 and 5) are recommended.  The
others are provided only for experimentation, and may significantly increase
the execution time of the program.  The annealing modes are not fully
implemented in the code at this time, but it would be trivial to do so if
desired.

The amoeba mode uses a full 6 degree of freedom search from the starting point
(derived from the best neighbor).  The starting point must be within 2 pixels.
The amoeba2 mode uses only 2 degrees of freedom (x/y offsets only) so it will
be faster, at the possible expense of accuracy.  The starting point must also
be within 2 pixels.  amoeba2 is not recommended for images that are not derived
from a stereo camera, e.g. using different instruments or involving motion
between the two frames.  The other modes generally do not have a 2 pixels
starting point limitation, so they might be useful for scenes with wildly
varying disparity values.  However, they are so slow that it will usually be
better to supply multiple seed points in each area using MARSTIE.

The template (correlation patch) and search area sizes may be rectangular
instead of square.  For landed images such as Mars Pathfinder or the Mars 98
lander, it may be advantageous to specify areas that are much wider than
they are tall.

Output file contents:

All output files are in the coordinates of the first (left eye) image.
For example if the sample disparity file has a value of 56.67 at sample 50
it means that the sample location of a tiepoint located at sample 50 in the
left eye image corresponds to sample 56.67 in the right eye image.   

The line and sample disparities are normally in two separate files.  However,
if only one filename is provided, both are written to a single, 2-banded
file, with line in the first band and sample in the second.

First output (or band): A REAL image containing the line disparity.  The
line/sample coordinate of each pixel in the output defines the position
in the left eye.  The value of the pixel contains the line coordinate of
the corresponding pixel in the right eye image.

Second output (or band): A REAL image containing the sample disparity.  The
line/sample coordinate of each pixel in the output defines the position
in the left eye.  The value of the pixel contains the sample coordinate of
the corresponding pixel in the right eye image.

If both line & sample disparity values are 0.000 the point has no value
(meaning correlation failed for that point).

Note that all disparity values use 1-based coordinates for the right
image, per VICAR conventions.

Mask file (optional): A BYTE image showing the coverage of tiepoints.
 0 dn means the pixel could not be reached in order to be correlated
   (i.e. there were no neighbors to supply an initial value, or TPTLIMIT
   was reached).
 128 dn means a correlation was successfully performed at this location.
 255 dn means a correlation was attempted at this location but it failed,
   usually because of low correlation quality.

Output quality file (optional): A REAL image containing the correlation
quality of each pixel attempted, from 0 to 1.  0 indicates either a
correlation failure unrelated to the QUALITY setting, or a pixel that was
not reached (the MASK output can distinguish).  Note that the file will
contain just a thin border of poor-quality pixels around each area,
because poor-quality pixels prevent the correlator from searching farther
in that direction.
.PAGE

HISTORY:
12-1-95  Initial MPFTPT program by J Lorre. 
July 99  Signficant internal restructuring and addition of features.
         Program renamed to marscorr.  Bob Deen
COGNIZANT PROGRAMMER:  Bob Deen

.LEVEL1
.VARI INP
input images.
first: left eye
second: right eye

.VARI OUT
Output files
first: line disparity
second: sample disparity

.VARI MASK
Output mask file
(optional)

.VARI OUT_QUALITY
Output quality image
(optional)

.VARI BAND
The vicar image 
band number. 
Defaults to 1

.VARI TEMPLATE
correlation size

.VARI SEARCH
correlation search
area

.VARI QUALITY
Minimum acceptable
correlation quality.

.VARI TPTLIMIT
Limit number of
tiepoints to TPTLIMIT

.VARI SEED
Starting tiepoint
location.
l,s,l,s

.VARI SEEDFILE
MARSTIE tiepoint file
with multiple seeds

.VARI SEEDPAIR
image numbers for
seedfile file

.VARI AMAX
Maximum template/
search areas

.VARI MODE
Correlation mode.
Use only amoeba,
amoeba2.

.VARI DATA_SET_NAME
Specifies the full name given
to a data set or a data product.

.VARI DATA_SET_ID
Specifies a unique alphanumeric
identifier for a data set or data
product.

.VARI RELEASE_ID
Specifies the unique identifier
associated with the release to the
public of all or part of a data set.
The release number is associated with
the data set, not the mission.

.VARI PRODUCT_ID
Specifies a permanent, unique
identifier assigned to a data
product by its producer.

.VARI PRODUCER_ID
Specifies the unique identifier
of an entity associated with the
production a data set.

.VARI PRODUCER_INST
Specifies the full name of the
identity of an entity associated
with the production of a data set.

.VARI TARGET_NAME
Specifies a target.

.VARI TARGET_TYPE
Specifies the type of a named target.

.LEVEL2
.VARI INP
First left eye image, then right eye image.

There is nothing actually requiring left/right order, other than convention.
If left/right is unclear (e.g. the images are not from a stereo camera) then
either order is acceptable.  If the output is used with MARSXYZ, the same
order must be used.

.VARI OUT
The line and sample disparity files.  If one filename is given, a two-banded
file is created with line disparity as band 1 and sample disparity as band 2.
If two filenames are given, two single-band files are created.  Line disparity
is in file 1, and sample disparity is in file 2.

See the main program help for output file contents and formatting.

.VARI MASK
Optional output file showing the coverage of tiepoints (correlated pixels),
in BYTE format.
 0 dn means the pixel could not be reached in order to be correlated.
   (i.e. there were no neighbors to supply an initial value, or TPTLIMIT
   was reached).
 128 dn means a correlation was successfully performed at this location.
 255 dn means a correlation was attempted at this location but it failed,
   usually because of low correlation quality.

.VARI OUT_QUALITY
Output quality file (optional): A REAL image containing the correlation
quality of each pixel attempted, from 0 to 1.  0 indicates either a
correlation failure unrelated to the QUALITY setting, or a pixel that was
not reached (the MASK output can distinguish).  Note that the file will
contain just a thin border of poor-quality pixels around each area,
because poor-quality pixels prevent the correlator from searching farther
in that direction.

This file could be used in conjunction with a very low quality setting
to allow correlation in low-quality areas, with the result filtered
afterwards using a higher quality (i.e. use the output quality file as
a mask).  However, this is somewhat dangerous, especially if there is
any kind of repeating pattern in the image - the correlator could get
"stuck" on the wrong match for the pattern.

.VARI BAND
The vicar image band number for the input images.  Defaults to 1

.VARI TEMPLATE
Correlation size.  Must be an odd number.  Defaults to 15 square.

If only one value is given, a square template is used.  If two values are
given, the first is the template height (line direction) and the second is
the template width (sample direction).  Rectangular templates that are
wider than they are tall should be useful for lander images.

.VARI SEARCH
Correlation search area.  Must be an odd number.  Defaults to 35 square.
SEARCH must be > TEMPLATE.  If SEARCH is only a bit larger than TEMPLATE
then many correlations will abort because they will be prohibited from
searching in promising directions. 

If only one value is given, a square search area is used.  If two values are
given, the first is the search height (line direction) and the second is
the search width (sample direction).  Rectangular search areas that are
wider than they are tall should be useful for lander images.

Note that SEARCH is not used for seed points, AMAX(2) is.  However, the
TEMPLATE parameter *is* used for seed points.

.VARI QUALITY
Minimum acceptable correlation quality.  Correlations with qualities below
QUALITY will be rejected. Qualities range from 0 (poor) to 1 (excellent).
Defaults to 0.6  

.VARI TPTLIMIT
Limit number of tiepoints to the first TPTLIMIT values.  Defaults to -1 which 
indicates that all points are to be acquired.  This limits the growth of
the search window around the seed point.  However, the gore-filling pass is
not constrained by TPTLIMIT.

If there are multiple seed points, TPTLIMIT represents an aggregate of all
correlated points, not ones derived from each seed point.

.VARI SEED
Starting tiepoint seed location.
In the order: left line, left sample, right line, right sample.

If SEEDFILE is specified, this parameter is ignored.

.VARI SEEDFILE
Specifies a file of tiepoints from the program MARSTIE.  These tiepoints are
used as seed points for MARSCORR.  Multiple seed points allows correlations
in areas separated from the rest of the image by large disparity displacements
or uncorrelateable areas such as undifferentiated sand.

See also SEEDPAIR.

.VARI SEEDPAIR
Specifies which image numbers to use from the SEEDFILE.  Normally, MARSTIE
will be run on a single pair of images only, in which case SEEDPAIR can be
defaulted (to (0,1)).  However, if the tiepoint file contains tiepoints for
many different image pairs, SEEDPAIR can be used to specify which image numbers
to use for this run of MARSCORR.  The numbers are 0-based and correspond to
the first two columns of the tiepoint file.

.VARI AMAX
Specifies the maximum template and search areas.  AMAX(1) is not very useful,
but AMAX(2) is used for seed point correlations as the search area (which is
always square).  An error is generated if TEMPLATE or SEARCH exceed the
AMAX limits.

.VARI MODE
Specifies which mode of the gruen correlator to use.

All correlations are performed using the gruen correlation routine.  See
the gruen documentation for details of the algorithm.  Seed points are
always correlated using mode 3 (linear followed by amoeba) to handle large
offsets.  The rest of the points may be correlated using any gruen mode
via the MODE parameter:

linear:            gruen mode 0
annealing:         gruen mode 1
amoeba:            gruen mode 2
linear_amoeba:     gruen mode 3
annealing_amoeba:  gruen mode 4
amoeba2:           gruen mode 5
linear_amoeba2:    gruen mode 6

Of the above, only amoeba and amoeba2 (modes 2 and 5) are recommended.  The
others are provided only for experimentation, and may significantly increase
the execution time of the program.  The annealing modes are not fully
implemented in the code at this time, but it would be trivial to do so if
desired.

The amoeba mode uses a full 6 degree of freedom search from the starting point
(derived from the best neighbor).  The starting point must be within 2 pixels.
The amoeba2 mode uses only 2 degrees of freedom (x/y offsets only) so it will
be faster, at the possible expense of accuracy.  The starting point must also
be within 2 pixels.  amoeba2 is not recommended for images that are not derived
from a stereo camera, e.g. using different instruments or involving motion
between the two frames.  The other modes generally do not have a 2 pixels
starting point limitation, so they might be useful for scenes with wildly
varying disparity values.  However, they are so slow that it will usually be
better to supply multiple seed points in each area using MARSTIE.

.VARI DATA_SET_NAME
The DATA_SET_NAME typically identifies the instrument that acquired the
data, the target of that instrument, and the processing level of the data.
This value is copied to the output label, property IDENTIFICATION,
keyword DATA_SET_NAME.

.VARI DATA_SET_ID
The DATA_SET_ID value for a given data set or product is constructed
according to flight project naming conventions.  In most cases the
DATA_SET_ID is an abbreviation of the DATA_SET_NAME.
This value is copied to the output label, property IDENTIFICATION,
keyword DATA_SET_ID.

.VARI RELEASE_ID
When a data set is released incrementally, such as every three months during
a mission, the RELEASE_ID is updated each time part of the data set is released.
For each mission(or host id if multiple spacecrafts), the first release of a data
set should have a value of "0001".
This value is copied to the output label, property IDENTIFICATION,
keyword RELEASE_ID.

.VARI PRODUCT_ID
Specifies a permanent, unique identifier assigned to a data product by
its producer. Most commonly, it is the filename minus the extension.
This value is copied to the output label, property IDENTIFICATION,
keyword PRODUCT_ID.

.VARI PRODUCER_ID
Specifies the unique identifier of an entity associated with the
production of a data set. This value is copied to the output label,
property IDENTIFICATION, keyword PRODUCER_ID.

.VARI PRODUCER_INST
Specifies the identity of a university, research center, NASA center or other
institution associated with the production of a data set.
This value is copied to the output label, property IDENTIFICATION, keyword
PRODUCER_INSTITUTION_NAME.

.VARI TARGET_NAME
Specifies a target.  The target may be a planet, satelite, ring, region, feature,
asteroid or comet.  This value is copied to the output label, property
IDENTIFICATION, keyword TARGET_NAME.

.VARI TARGET_TYPE
Specifies the type of a named target. This value is copied to the output
label, property IDENTIFICATION, keyword TARGET_NAME.
