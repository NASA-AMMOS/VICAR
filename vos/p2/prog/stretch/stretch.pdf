PROCESS     HELP=*
PARM INP      TYPE=STRING  COUNT=1:2         
PARM OUT      TYPE=STRING  COUNT=1           
PARM SIZE     TYPE=INTEGER COUNT=4           DEFAULT=(1,1,0,0)
PARM SL       TYPE=INTEGER COUNT=1 VALID=(1:99999)	DEFAULT=1
PARM SS       TYPE=INTEGER COUNT=1 VALID=(1:99999)	DEFAULT=1
PARM SB       TYPE=INTEGER COUNT=1 VALID=(1:99999)	DEFAULT=1
PARM NL       TYPE=INTEGER COUNT=1 VALID=(0:99999)	DEFAULT=0
PARM NS       TYPE=INTEGER COUNT=1 VALID=(0:99999)	DEFAULT=0
PARM NB       TYPE=INTEGER COUNT=1 VALID=(0:99999)	DEFAULT=0
PARM LINEAR   TYPE=REAL    COUNT=(0,2)			DEFAULT=--
PARM DNMIN    TYPE=INTEGER COUNT=1 VALID=(-32768:0)	DEFAULT=0
PARM DNMAX    TYPE=INTEGER COUNT=0:1 VALID=(0:32767)	DEFAULT=255
PARM ASTRETCH TYPE=KEYWORD COUNT=0:1 VALID=ASTRETCH	DEFAULT=--
PARM PERCENT  TYPE=REAL    COUNT=0:1 VALID=(0.:100.)	DEFAULT=2.
PARM LPERCENT TYPE=REAL    COUNT=0:1 VALID=(0.:100.)	DEFAULT=1.
PARM HPERCENT TYPE=REAL    COUNT=0:1 VALID=(0.:100.)	DEFAULT=1.
PARM COMP     TYPE=KEYWORD COUNT=0:1 VALID=COMP     DEFAULT=-- 
PARM CLIP     TYPE=INTEGER COUNT=(0,1)              DEFAULT=--
PARM LOGARITH TYPE=KEYWORD COUNT=0:1 VALID=LOG      DEFAULT=--
PARM LOG      TYPE=REAL    COUNT=(0,2) VALID=(-10E15:10E15)       DEFAULT=--
PARM CURVE    TYPE=REAL    COUNT=0:1 VALID=(0.0001:10E15)         DEFAULT=1.0
PARM FUNCTION TYPE=STRING  COUNT=0:1                DEFAULT=--
PARM PSTRETCH TYPE=KEYWORD COUNT=0:1 VALID=PSTRETCH DEFAULT=--
PARM FREQ     TYPE=REAL    COUNT=0:1                DEFAULT=1
PARM AMPL     TYPE=REAL    COUNT=0:1                DEFAULT=--
PARM PHI      TYPE=REAL    COUNT=0:1                DEFAULT=0
PARM DC       TYPE=REAL    COUNT=0:1                DEFAULT=--
PARM CONTOUR  TYPE=INTEGER COUNT=(0,1) VALID=(1:65538)            DEFAULT=--
PARM ALARM    TYPE=INTEGER COUNT=(0,1:256) VALID=(-32768:32767)   DEFAULT=--
PARM DNVALUE  TYPE=INTEGER COUNT=0:1 VALID=(-32768:32767)         DEFAULT=--
PARM TABLE    TYPE=REAL    COUNT=(0,2:512) VALID=(-32768.:32767.) DEFAULT=--
PARM ITABLE   TYPE=INTEGER COUNT=(0,2:512) VALID=(-32768:32767)   DEFAULT=--
PARM BACKGND  TYPE=INTEGER COUNT=0:1 VALID=(-32768:32767)         DEFAULT=--
PARM PEAK     TYPE=KEYWORD COUNT=0:1 VALID=PEAK     DEFAULT=--
PARM MEAN     TYPE=KEYWORD COUNT=0:1 VALID=MEAN     DEFAULT=--
PARM RANGE    TYPE=INTEGER COUNT=0:1		    DEFAULT=--
PARM FACTOR   TYPE=REAL    COUNT=0:1		    DEFAULT=--
PARM SMOOTH   TYPE=KEYWORD COUNT=0:1 VALID=SMOOTH   DEFAULT=--
PARM GAUSS    TYPE=KEYWORD COUNT=0:1 VALID=GAUSS    DEFAULT=--
PARM GSIGMA   TYPE=REAL    COUNT=0:1 VALID=0.0005:1000.  DEFAULT=3.0
PARM GMEAN    TYPE=REAL    COUNT=0:1 VALID=-32767.:32766.         DEFAULT=--
PARM ELLIPSE  TYPE=KEYWORD COUNT=0:1 VALID=ELLIPSE  DEFAULT=--
PARM POWER    TYPE=INTEGER COUNT=0:1 VALID=0:99999  DEFAULT=--
PARM BIMODAL  TYPE=INTEGER COUNT=0:6 VALID=-32768:32767           DEFAULT=--
PARM REXCLUDE TYPE=INTEGER COUNT=(0,2:200) VALID=-32768:32767     DEFAULT=--
PARM IEXCLUDE TYPE=INTEGER COUNT=(0,1:100) VALID=-32768:32767     DEFAULT=--
PARM INCLUDE  TYPE=KEYWORD COUNT=0:1 VALID=INCLUDE  DEFAULT=--
PARM CUT      TYPE=REAL    COUNT=0:1 VALID=0:100    DEFAULT=--
PARM POST     TYPE=INTEGER COUNT=(0,2) VALID=-32768:32767   DEFAULT=--
PARM IHIST    TYPE=KEYWORD COUNT=0:1 VALID=IHIST    DEFAULT=--
PARM OHIST    TYPE=KEYWORD COUNT=0:1 VALID=OHIST    DEFAULT=--
PARM SPIKES   TYPE=INTEGER COUNT=0:1 VALID=0:65536  DEFAULT=3
PARM ICDF     TYPE=KEYWORD COUNT=0:1 VALID=ICDF     DEFAULT=--
PARM OCDF     TYPE=KEYWORD COUNT=0:1 VALID=OCDF     DEFAULT=--
PARM AREA     TYPE=INTEGER COUNT=0:4 VALID=1:99999  DEFAULT=--
PARM LINC     TYPE=INTEGER COUNT=0:1 VALID=1:100    DEFAULT=1
END-PROC
.TITLE
Contrast enhancement via DN transformation
.HELP
PURPOSE:

STRETCH is a VICAR application program for changing the contrast of an image.
More generally, the program changes the intensity of each pixel by performing
a transformation on the DN values:

            output_DN = T(input_DN)

Approximately 20 different transformations T are available.  Some of these
are analytic functions (e.g. linear, lorarithmic) and some are defined so
as to modify the image histogram is some specified manner.  See also programs
F2, FIT, HSTRETCH, STRETVAR.

.page
EXECUTION:

    STRETCH  INP=IPIC  OUT=OPIC  user-parameters....
 or STRETCH  INP=(IPIC,HIST)  OUT=OPIC  user-parameters...
where
    IPIC is the input image (byte or halword)
    HIST is an optional histogram file as generated by HISTGEN
    OPIC is the output image (same data format as input)

The type of transformation desired is specified via parameters.  If no
parameters are specified, a linear transformation which saturates 1 percent of
the data at both low and high ends of the histogram is performed (see
ASTRETCH parameter).

.page
OPERATION:

STRETCH performs a transformation T which maps every input DN value (IDN) to
an output DN value (ODN):

		            ODN = T(IDN)

The transformation is defined for all possible input DN values (0 to 255 DN
for byte data and -32768 to 32767 DN for halfword data).  Whenever an input DN
value leads to some mathematical difficulty, it is replaced by a more acceptable
input.  For example:

	STRETCH IN OUT FUNC="255/IN1"		0 DN is replaced by 1 DN
        STRETCH IN OUT FUNC="255*LOG(IN1)"      All DN<1 replaced by 1 DN

The DN range of the output image may be specified via the DNMIN and DNMAX
parameters.  If the transformation maps a DN value outside this range, then
ODN is set equal to these limits.  Note that many of the stretch options adjust
the DN scale so as to map the input DNs over the entire output range.  The
defaults for DNMIN and DNMAX are 0 and 255 for byte images and -32768 and 32767
for halfword images. The max input image width is 524288 pixels.

.page
TYPES OF STRETCH FUNCTIONS:

Approximately 20 different transformations are available.  Some of these
are analytic functions (e.g. linear, lorarithmic) and some are defined so
as to modify the image histogram is some specified manner.

The non-histogram stretches are specified by the following keywords:

    LINEAR,COMP,TABLE			Linear and piece-wise linear stretches
    LOGARITHMIC,PSTRETCH,FUNCTION	Analytic functions
    CONTOUR,ALARM,ITABLE		Image contouring
    CLIP				Bit clipping

The histogram stretches are:

    ASTRETCH,PEAK,MEAN			Linear stretches
    SMOOTH,GAUSS,ELLIPSE,POWER		Histogram matching stretches

Histogram stretches require that the histogram of the input image be computed.
Alternatively, the histogram may be included as an optional input file.

Each of the above stretches may be followed by a post stretch.	POST=(n1,n2)
causes a linear transformation such that DNMIN is mapped to n1 and DNMAX is
mapped to n2.

.page
NON-HISTOGRAM STRETCHES:

These stretches are based on some analytic function (e.g. linear, logarithmic).
The following is a summary of all available options.  See the help for each
individual keyword for a detailed description.

(1) Linear and piece-wise linear stretches:

        STRETCH  IN  OUT  LINEAR=(lowdn,highdn)
        STRETCH  IN  OUT  TABLE=(i1,o1,i2,o2,i3,o3,..,iN,oN)
        STRETCH  IN  OUT  'COMP

    LINEAR is a linear function which maps lowdn to DNMIN and highdn to DNMAX.
    TABLE defines a piece-wise linear function which maps i1 to o1, etc.
    COMP is a linear function which maps DNMIN to DNMAX and DNMAX to DNMIN
    (complementing the image).

(2) Non-linear stretches:

        STRETCH  IN  OUT  LOG=(lowdn,highdn)  CURVE=c
        STRETCH  IN  OUT  'PSTRETCH  AMPL=a  FREQ=f  PHI=p  DC=do
        STRETCH  IN  OUT  FUNCTION="fortran-expression"

    LOG is a natural log function for increasing the contrast of low DN areas.
    PSTRETCH is a sinusoidal function with specifiable period and amplitude.
    FUNCTION permits the function to be defined via a FORTRAN-like expression.

(3) Contouring and DN mapping:

        STRETCH  IN  OUT  CONTOUR=n  DNVALUE=m
        STRETCH  IN  OUT  ALARM=(dn1,dn2,dn3,...)  DNVALUE=m
        STRETCH  IN  OUT  ITABLE=(i1,o1,i2,o2,i3,o3,..,iN,oN)

    CONTOUR sets every nth DN value to m.
    ALARM sets DN values dn1, dn2, dn3,... to m.
    ITABLE sets DN values i1 to o1, i2 to o2,...

    All other DN values are left unchanged.  Alternatively, if BACKGND=b is
    specified, then all other DN values are set to b.

(4) Bit clipping:

        STRETCH  IN  OUT  CLIP=n

    If n is positive, the bits are shifted left.  If n is negative, the
    bits are shifted right.  This causes the n most-significant-bits or
    least-significant-bits to be truncated.  Shifting the bits left causes
    the output DN range to be reused multiple times, causing image contouring.

.page
HISTOGRAM STRETCHES:

Histogram stretches all require that the histogram of the input image be
first computed, or included as a secondary input file.  During histogram
computation, all input pixels less than DNMIN or greater than DNMAX are set
equal to these values.

The area of the image from which the histogram is computed can be specified via
the AREA parameter.  LINC=n parameter causes every nth line to be used to
compute the histogram.

Unless 'INCLUDE is specified, all histogram stretches ignore the data at the
limits (DNMIN and DNMAX) when computing the transfer function.  The REXCLUDE,
IEXCLUDE, and CUT parameters can be used to exclude additional data from
the histogram as well.

The following is a brief description of each histogram stretch.  See the
help on each individual parameter for a more detailed description.

(1) Linear stretches:

        STRETCH  IN  OUT  'ASTRETCH  LPERCENT=r1  HPERCENT=r2
        STRETCH  IN  OUT  'PEAK
        STRETCH  IN  OUT  'MEAN

    ASTRETCH is similar to LINEAR, except that the stretch limits n1 and n2
    are determined by saturating r1 and r2 percent of the data from the
    low and high ends of the histogram.

    PEAK and MEAN are useful variants of ASTRETCH.  The stretch limits n1
    and n2 are determined as before.  A piece-wise linear function is used
    to map n1 to DNMIN, n2 to DNMAX, and the median or mean pixel value to
    the mid-range of the output image, i.e. (DNMIN+DNMAX)/2.

(2) Histogram matching stretches:

        STRETCH  A  B  'SMOOTH
        STRETCH  A  B  'GAUSS  GSIGMA=s  GMEAN=m
        STRETCH  IN  OUT  'ELLIPSE
        STRETCH  IN  OUT  POWER=r

    For these stretches, the transfer function is computed so that the
    histogram of the output image approximates a certain specified shape.
    The shape is only approximated since all pixels with the same input DN
    must map to the same output DN.

    KEYWORD	SHAPE OF OUTPUT HISTOGRAM		
    --------	-------------------------
    SMOOTH 	uniform distribution (all DN values have equal frequencies)
    GAUSS 	normal (or Gaussian) distribution centered about midrange
    ELLIPSE	top half of an ellipse centered about midrange
    POWER	Of the form y=1-|x|**r, but scaled and centered at midrange


.page
HISTOGRAM PRINT OPTIONS:

If the input image is in byte data format, several histogram print options
apply.

    IHIST prints the histogram of the input image
    OHIST prints the histogram of the output image
    ICDF  prints the Cumulative Distribution Function of the input image
    OCDF  prints the Cumulative Distribution Function of the output image

The CDF is computed from the histogram of the input image as follows:

                               i
                     CDF(i)=  SUM  HIST(j)      for i=0,1,2,3,...,n-1
                               j=0

where CDF(i) is the total number of pixels with DN values less than or equal
to i, and the histogram HIST has n grey levels.

.page
TIMING:

The transformation is first computed in the form of a look-up table, i.e.
a table which contains the output DN value for every possible input DN value.
For byte data, the table contains 256 values (0 to 255 DN).  For halfword data,
the table contains 2**16 values (-32768 to 32767 DN).  If a post stretch is
specified, this stretch is combined in the look-up table.

After the look-up table has been computed, it is used to create the output
image.  Each pixel in the input image is replaced by its corresponding output
value in the table.  Because of the use of the look-up table, program execution
time is not significant and is independent of the complexity of the
transformation.

.page
EXAMPLES:

Type in the following commands and observe the results.

gen a 10 10	!Create a 10x10 byte image
list a		!Print the image

After each of the following executions of stretch, print the results as follows:

list b

!.............Complementing the image (3 equivalent ways)........
stretch a b 'comp
stretch a b linear=(255,0)
stretch a b table=(0,255,255,0)

!.............Linear histogram stretch (2 equivalent ways)........
histgen a h				!First compute histogram h
stretch (a,h) b perc=5. 'include	!and input it to stretch
stretch a b perc=5. 'include		!Or make stretch compute histogram

!.............Piecewise linear histogram stretches........
f2 a c func="0.5*in1**2"		!Could have used stretch to do this
stretch c b 'mean 'include		!Put the mean in the middle
stretch c,b 'peak 'include		!Put the median in the middle
stretch c b 'peak 'include range=41	!This doesn't look too useful
stretch c b 'peak 'include factor=2	!This doesn't look too useful either

!.............Bimodal stretch (do not try this at home)........
stretch a b func="in1+18"
concat (a,b) c ns=20 'nost	!Create image with bimodal histogram
hist c				!See?  Bimodal
size c d zoom=10 'noin		!Make it larger or algorithm won't work
stretch d e bimodal=0 'ohist	!Auto-stretches around both peaks

!.............Bit clipping (2 equivalent ways)...............
stretch a b clip=6
stretch a b func="mod(64*DN1,256)"

!.............Contouring (3 equivalent ways)...................
stretch a b contour=4 dnvalue=100
stretch a b alarm=(0,4,8,12,16) dnvalue=100
stretch a b itable=(0,100,4,100,8,100,12,100,16,100)

!.............Logarithmic function (2 equivalent ways).......
stretch a b log=(0,18)
stretch a b func="86.6039343332527*ln(IN1+1)"

!.............Sinusoidal function (3 equivalent ways)..............
stretch a b 'pstretch freq=16 phi=128 ampl=100 dc=49.5
stretch a b func="(100/2)*sin((2*3.1415*16*dn1)/255+128)+49.5"
f2 a b func="(100/2)*sin((2*3.1415*16*dn1)/255+128)+49.5"

!................Histogram-matching stretches.....
stretch a b 'smooth 'ohist
stretch a b 'ellipse 'ohist
stretch a b power=1 'ohist
stretch a b 'gauss gsigma=5.0 gmean=137.5 'ohist

.page
PROGRAM HISTORY:

The current version of STRETCH began as two older programs:

(1) STRETCH, written by Tom Rindfleish (April 4, 1969) contained the
    non-histogram stretches.
(2) ASTRTCH2, written by Arnie Schwartz (August 3, 1971) contained the
    histogram stretches.

The two programs were merged and the FUNCTION keyword added by John Reimer.

Written by:  J. H. Reimer   10/31/85
Cognizant programmer: Lucas Kamp
Revision history:
1987-05    SP - Used NINT function for rounding for compatibility with the previous
           version of stretch for negavite DNs.
1987-06    SP - Added parms parameter in PDF to be compatible with ASTRTCH2.
1988-01    SP - Added 'INCLUDE and changed EXCLUDE defaults to agree with ASTRTCH2.
1988-10    SP - Extended linear stretch to handle inversion.  This means that
           linear=(255,0) is the same as 'COMP.
1992-05    SP - oMade portable for UNIX.
	   o Used Niles Ritter changes to replace calls to OUTCON.
	   o Adapted for new version of KNUTH.
           o Added call xvpcnt('INP',ni) to fix FR 46486.
	   o Replaced variable ITOL with RTOL in Subroutine FCLIP because
           the code had a bizarre .05 in it and really was not per spec.
           o Followed Ron Alley's lead in deleting the RATIO parameter
           because it had no effect.  (It cancels itself out in the
           calculation.)
           o Corrected the DC default for PSTRETCH to be the average of DNMAX
	   and DNMIN.
           o Fixed error for byte data where DNMAX<255.  Routines INIT and ALTER
	   were assuming that LUT has 256 entries. I make sure LUT is at least
           256 halfwords, and I fill it all in.
	   o Fixed default DC for PSTRETCH.  Clarified Help that AMPL=
           2*(mathematical amplitude) for PSTRETCH.
	   o Added GMEAN parameter for FR 48458.  Note that the default
           GMEAN used to be 127 = (255-0)/2 for BYTE data.  The default
           is now 127.5 = (255+0)/2.0, which makes STRETCH consistent
           with VIDS JSTRETCH.
1992-09    JFM - Data number in STATI set to a REAL*2 value to avoid integer
           overflow when dealing with negative DN values. (FR 76821)
1992-10    SP - o Changed name of subroutine MAIN to WORK to avoid name collisions.
           o Added EXTERNAL statement to prevent compiler warnings.
1993-02    SP - o Added Logarithmic stretch ala VIDS.
           o Move initializers into data statements to comply with Porting Guide.
	   o Made LINEAR parameters REAL instead of INTEGER ala VIDS.
1995-03    CRS (CRI) - MSTP S/W CONVERSION (VICAR PORTING)
           Revised to use Histogram files in IBIS format
2002-10    GMY - 1) Massive code reorganization.
           2) Rewrote help file, documenting each stretch option.
           3) Rewrote test script, testing all stretch options.
           4) Fixed numerous bugs detected as a result of new test script.
2003-08    NTT - Enabled 3D image capability to stretch and get_histogram.
2007-08    LWK - 1. Fixed problem in STABLE where a very steep slope resulted in loss
           of precision in computing LUT, by doing the calculation in double
           precision.
           2. Fixed error in RTRUNC rounding negative numbers.
           3. Increased size of buffer passed to KNUTH from 100 to 300 words
           (was causing crash in Linux).
           4. Removed COMMON/CW/ lines in MANUAL_STRETCH.F which were not being
           used as COMMONs and were causing compiler warnings due to unequal
           lengths.
2013-01    LWK - Fixed CHARACTER continuation lines in print_histogram.f for new compiler
           flag on Solaris.
2021-07-01 WLB - Quadrupled i/o buffer size; added check so buffer is not exceeded; added check
           for histogram calculation overflow.
2021-07-14 WLB - Doubled (again) i/o buffer size; forced hist values to 2^31-1 on overflow. Also
           see p2/sub/hsub changes.

.page
PROGRAMMER'S NOTES:

The following is the subroutine tree for STRETCH:

STRETCH
WORK
  MANUAL_STRETCH
    SCOMP		IMODE=1
    SLINEAR		IMODE=2
    SCLIP		IMODE=3
    SCONTOUR		IMODE=4
    SALARM		IMODE=5
    STABLE		IMODE=6
    SITABLE		IMODE=7
    SPERIODIC		IMODE=8
    SFUNC		IMODE=9
    SLOG		IMODE=10
  HIST_PARAMS
  GET_HISTOGRAM
    READ_HISTOGRAM
    COMPUTE_HISTOGRAM
      HISGET
  PRINT_HISTOGRAM
  EXCLUDE_HISTOGRAM
    FCLIP	Exclude HIST entries less than given % from max
  HISTOGRAM_STRETCH
    HMOD	Compute LUT which modifies histogram to one of the following:
      NRAMP	'SMOOTH		IMODE=11
      NGAUSS	'GAUSS		IMODE=12
      NELLIP	'ELLIPSE	IMODE=13
      NPOWER	'POWER		IMODE=14
    BIMODAL			IMODE=15
      TWOPK
        HFILT	Apply low-pass filter to HIST
        HDIFF	Compute derivative (HIST(I)-HIST(I-1) of histogram
    SPEAK	'PEAK and 'MEAN IMODE=16 or 17
    ASTRETCH	'ASTRETCH	IMODE=18
  POST_STRETCH	Modify LUT for POST stretch
  STRETCH_IMAGE	Use the LUT to stretch the image and write to output file
  PRINT_OHISTOGRAM  Print output histogram

Utility routines:
CHK_NUM_STRETCH	Increment nstretch and ABEND if greater than 1
STATI		Compute mean and standard deviation from histogram
PTABLE		Print the LUT
PHIST		Print HIST
CDF		Compute the CDF from HIST and print it

.LEVEL1
.VARIABLE INP
INP=image  or
INP=(image,histogram)
.VARIABLE OUT
OUT=output_image
.VARIABLE SIZE
SIZE=(sl,ss,nl,ns)
(4 Integers)
.VARIABLE SL
Starting line
(1 integer)
.VARIABLE SS
Starting sample
(1 integer)
.VARIABLE SB
Starting band
(1 integer)
.VARIABLE NL
Number of lines
(1 integer)
.VARIABLE NS
Number of samples
(1 integer)
.VARIABLE NB
Number of bands
(1 integer)
.VARIABLE DNMIN
Minimum output DN
(1 Integer)
.VARIABLE DNMAX   
Maximum output DN  
(1 Integer)     
.VARIABLE LINEAR
Linear function
LINEAR=(r1,r2)
(2 reals)
.VARIABLE ASTRETCH          
Auto-stretch (linear)
(Keyword)                  
.VARIABLE PERCENT
Total percentage of image
to be saturated.
.VARIABLE LPERCENT
Percentage of image to be
saturated at the low end.
.VARIABLE HPERCENT
Percentage of image to be
saturated at the high end.
.VARIABLE COMP     
Complement the image
(Keyword)          
.vari logarith
Logarithmic stretch
.vari log
LOG=(low,high)
Logarithmic stretch
.vari curve 
Curvature of logarithmic
stretch (real)
.VARIABLE FUNCTION       
(String)
Fortran-like exptression
Ex: FUNC="2*DN+1")
.VARIABLE CLIP
Bit clipping
(Integer)
.VARIABLE PSTRETCH
Periodic stretch
(Keyword)
.VARIABLE FREQ
Frequency used in PSTRETCH
(Real)
.VARIABLE AMPL
Amplitude used in PSTRETCH
(Real)
.VARIABLE PHI
Phase used in PSTRETCH
(Real)
.VARIABLE DC
Mean used in PSTRETCH
(Real)
.VARIABLE CONTOUR
Contour interval
(Integer)
.VARIABLE ALARM
Flag Dn values
ALARM=(dn1,dn2,...)
.VARIABLE DNVALUE
DN value for CONTOUR
and ALARM stretches
DN=integer
.VARIABLE TABLE
Piece-wise linear stretch
TABLE=(i1,o1,i2,o2,...)
(up to 100 pairs of reals)
.VARIABLE ITABLE
Change specific DN values
ITABLE=(i1,o1,i2,o2,...)
(up to 256 pairs of integers)
.VARIABLE BACKGND
Background DN value
(see CONTOUR,ALARM,ITABLE,
 TABLE)
.VARIABLE PEAK                
Auto-stretch around
median DN value
(Keyword)                    
.VARIABLE BIMODAL
Auto-stretch around
both peaks of a
bimodal histogram.
1-6 integers
.VARIABLE MEAN                
Auto-stretch around
mean DN value
(Keyword)                    
.VARIABLE RANGE
Range used in PEAK or MEAN stretch
(integer)
.VARIABLE FACTOR
Factor used in PEAK or MEAN stretch
(real)
.VARIABLE SMOOTH               
Output histogram has
uniform distribution
(Keyword)                     
.VARIABLE GAUSS                
Output histogram has
Gaussian distribution
(Keyword)                     
.VARIABLE GSIGMA
Standard deviation for
GAUSS stretch
(real)
.vari GMEAN
Mean for GAUSS stretch
(real)
.VARIABLE ELLIPSE              
Output histogram has
elliptic distribution
(Keyword)                    
.VARIABLE POWER             
Output histogram has
distribution of the
form y=1-|x|**r
(real)
.VARIABLE REXCLUDE
Range of DNs to exclude
from stretch
(N Pairs of Integers)
.VARIABLE IEXCLUDE
Individual DNs to exclude
from stretch.
(N Integers)
.VARIABLE INCLUDE
Include 0 and the maximum DN in
the histogram=.
(Keyword)                    
.VARIABLE CUT
CUT=r excludes DN's with
frequencies less than r%
of maximum frequency
from histogram.
(Real)
.VARIABLE POST              
POST=(lowdn,highdn)
Follow initial stretch
with linear stretch
maping DNMIN to lowdn
and DNMAX to highdn
(2 integers)     
.VARIABLE IHIST
Print input histogram
(Keyword)
.VARIABLE OHIST
Print output histogram
(Keyword)
.VARIABLE SPIKES
Number of spikes in
printed histogram
(1 Integer)
.VARIABLE ICDF
Print input CDF      
(Keyword)
.VARIABLE OCDF
Print output CDF     
(Keyword)
.VARIABLE AREA
Image area used to
calculate histogram
AREA=(sl,ss,nl,ns)
(4 integers)
.VARIABLE LINC
Line subsampling used in
computing histogram
(Integer)

.LEVEL2
.VARIABLE INP
	INP=A
     or INP=(A,H)
where
      A is the input image (byte or halfword).
      H is an optional histogram previously generated by HISTGEN.
.VARIABLE OUT
	OUT=B
where B is the output image.  B will have the same data format as the input
image.
.VARIABLE SIZE
	SIZE=(sl,ss,nl,ns)
Four integers, representing the standard Vicar size field.  This specifies an
image area by starting line, starting sample, number of lines, and number of
samples.
.VARIABLE SL
 INTEGER - Starting line
.VARIABLE SS
 INTEGER - Starting sample
.VARIABLE SB
 INTEGER - Starting band
.VARIABLE NL
 INTEGER - Number of lines
.VARIABLE NS
 INTEGER - Number of samples
.VARIABLE NB
 INTEGER - Number of bands
.VARIABLE DNMIN
		DNMIN=n1  DNMAX=n2	(n1 and n2 are integers)

Specifies the minimum and maximum DN values in the output image.  Many of the
stretch options adjust the DN scale so as to map the input DNs over the entire
output range.  All input pixels which map to an output value outside these
limits are set equal to these limits.

For byte images, the defaults are DNMIN=0 and DNMAX=255.
For halfword images, the defaults are DNMIN=-32768 and DNMAX=32767.  However,
if a HISTGEN created histogram is supplied as the second input, DNMIN=0.
.VARIABLE DNMAX
See parameter DNMIN for description.
.VARIABLE LINEAR
	STRETCH  IN  OUT  LINEAR=(r1,r2)	(real numbers r1, r2)

A linear transformation T is applied, mapping each input DN (IDN) onto an
output DN (ODN) such that r1 maps to DNMIN and r2 maps to DNMAX.  The actual
formula is:

	               DNMAX - DNMIN
		ODN = ---------------(IDN - r1) + DNMIN
			  r2 - r1

The transformation is truncated for all DN values outside the input range
defined by r1 and r2, since these would map outside the output range.

Note that r1 may be greater than r2.  For example, if the input image is 
in byte format (DNMIN=0,DNMAX=255), the operation
	STRETCH A B LINEAR=(255,0)
is equivalent to complementing the image
	STRETCH A B 'COMP
.VARIABLE CLIP
	STRETCH  IN  OUT  CLIP=n		(integer n)

If n>0, the binary representation of the DN value is shifted n bits to the left
and the n most significant bits are truncated.  If n<0, the bits are shifted to
the right and the n least significant bits are truncated.  The following
examples assume that the input image is byte data.

Ex:      STRETCH  A  B  CLIP=4
 
     The bits are shifted left 4 bits:  abcdefgh ----> efgh0000
     This has the same effect as

         STRETCH  A  B  FUNC="mod(16*DN,256)"

Ex:  STRETCH  A  B  CLIP=-4

     The bits are shifted right 4 bits:  abcdefgh ----> 0000abcd
     This has nearly the same effect as

         STRETCH  A  B FUNC="DN/16"

     However, in the latter, rounding occurs so that, for example, 8/16=1.
.VARIABLE ASTRETCH
		STRETCH  IN  OUT  'ASTRETCH
       or	STRETCH  IN  OUT  PERCENT=r
       or	STRETCH  IN  OUT  LPERCENT=r1  HPERCENT=r2

This is the default stretch.  A linear transformation is applied so that lowdn
maps to DNMIN and highdn maps to DNMAX.  The stretch limits (lowdn and highdn)
are computed so as to saturate r1 percent and r2 percent of the data from the
low and high ends of the histogram, respectively.

If PERCENT=r is specified, then r1 = r2 = 0.5*r.

See also parameters LPERCENT, HPERCENT, PERCENT, PEAK, MEAN, DNMIN, DNMAX,
REXCLUDE, IEXCLUDE, INCLUDE, and CUT.
.VARIABLE PERCENT
	PERCENT=r	(real number)

Specifies the total percentage of the input image to be saturated in the
auto-stretch option (0<=r<=100).  The above statement is equivalent to:

	LPERCENT=r1  HPERCENT=r1

where r1=r/2.  Used in the following stretches: ASTRETCH, PEAK, MEAN.
.VARIABLE LPERCENT
	LPERCENT=r1

Specifies the percentage of the input image to be saturated from the low end
of the histogram in the auto-stretch option (0<=r1<=100).  If defaulted, then
LPERCENT = PERCENT/2.  Used in the following stretches: ASTRETCH, PEAK, MEAN.
.VARIABLE HPERCENT
	HPERCENT=r2

Specifies the percentage of the input image to be saturated from the high end
of the histogram in the auto-stretch option (0<=r2<=100).  If defaulted, then
HPERCENT = PERCENT/2.  Used in the following stretches: ASTRETCH, PEAK, MEAN.
.VARIABLE COMP
	STRETCH  IN  OUT  'COMP

This is a linear transformation which maps DNMIN to DNMAX and DNMAX to DNMIN,
causing the image to be complemented (reversed).  The statement
	STRETCH A B 'COMP
is equivalent to
	STRETCH A B LINEAR=(255,0)
for byte images, and
	STRETCH A B LINEAR=(32767,-32768)
for halfword images.
.VARI LOGARITH
	STRETCH  IN  OUT  'LOG

This is equivalent to

	STRETCH  IN  OUT  LOG=(0,255)	for byte data
or      STRETCH  IN  OUT  LOG=(0,32767) for halfword data
.VARI LOG
	STRETCH  IN  OUT  LOG=(lowdn,highdn)  CURVE=c

The transformation is a natural logarithmic function of the form:

	ODN = a*ln(IDN+c) + b

where IDN and ODN are the input and output DN values of a pixel, c controls the
curvature of the function, and a and b are scale and offset terms calculated so
that lowdn maps to DNMIN and highdn maps to DNMAX.  The log stretch increases
the contrast in dark areas of the image at the expense of decreased contrast in
brighter areas.

The CURVE parameter c causes a horizontal offset to the log curve.  This
controls the portion of the curve that the input DNs are mapped onto.  Recall
that the slope of ln x approaches -infinity as x approaches 0.  Therefore, for
the curve to be defined over the entire input domain, we must have lowdn+c > 0.
The default is c=1.

See also parameters DNMIN, DNMAX.
.VARI CURVE 
	CURVE=c			(real number)

where 0 < c < 10**15.  Default is c=1.  See parameter LOG for description.
.VARIABLE FUNCTION
	STRETCH  IN  OUT  FUNCTION="fortran-like expression"

Allows the user to specify the transfer function as a FORTRAN-like expression
with the keyword DN as the independent variable.  This is similar to the VICAR
program F2.  For example,

	STRETCH  A  B  FUNCTION="2*DN+3"

multiplies each input DN value by 2 and adds 3.  All resulting values outside
the range specified by DNMIN and DNMAX are truncated.
.VARIABLE PSTRETCH
	STRETCH  IN  OUT  'PSTRETCH  AMPL=a  FREQ=f  PHI=p  DC=do

The transfer function is a periodic stretch of the form:

              a          2*PI*f*IDN
       ODN = --- * SIN( ------------- + p) + do
              2          DNMAX-DNMIN

The defaults are:	AMPL= DNMAX-DNMIN
			FREQ= 1.0
			PHI = 0.0
			DC  = (DNMAX+DNMIN)/2

These defaults map the input DN to one period of a sin wave, offset and scaled
so that the output has a range from DNMIN to DNMAX (see AMPL and DC terms).

See also parameters DNMIN, DNMAX.
.VARIABLE AMPL

	AMPL=a		(see keyword PSTRETCH)

Specifies the amplitude to be used in the periodic stretch.  Note that AMPL is
the peak-to-peak amplitude (i.e. 2 times what is the normal meaning of
amplitude).
.VARIABLE FREQ

	FREQ=r		(see keyword PSTRETCH)

Specifies the frequency to be used in the periodic stretch.
.VARIABLE PHI

	PHI=r		(see keyword PSTRETCH)

Specifies the phase to be used in the periodic stretch.
.VARIABLE DC

	DC=r		(see keyword PSTRETCH)

Specifies the mean output DN in the periodic stretch.
.VARIABLE CONTOUR

	STRETCH  IN  OUT  CONTOUR=n  DNVALUE=m

Input intensities which are a multiple of n are	set to the value m.  All
other DN values remain unchanged unless the BACKGND parameter is specified.

Ex: For byte images, the following will produce identical results, i.e.
    all pixels with DN values of 64, 128, and 192 are set to 0 DN.

        STRETCH  A  B  CONTOUR=64  DNVALUE=0
        STRETCH  A  B  ALARM=(64,128,192) DNVALUE=0

.VARIABLE ALARM
        STRETCH  IN  OUT  ALARM=(dn1,dn2,dn3,...)  DNVALUE=m

The input pixels with the DN values specified are set to the value m.  All
other DN values remain unchanged unless the BACKGND parameter is specified.

Ex: For byte images, the following will produce identical results, i.e.
    all pixels with DN values of 64, 128, and 192 are set to 0 DN.

        STRETCH  A  B  ALARM=(64,128,192) DNVALUE=0
        STRETCH  A  B  CONTOUR=64  DNVALUE=0
.VARIABLE DNVALUE
		DNVALUE=n

Specifies the replacement DN value for the CONTOUR and ALARM stretches. The
appropriate DN's will be set to this DN value.  (Default is DNVALUE=DNMAX)

See also parameters CONTOUR, ALARM, DNMAX.
.VARIABLE TABLE
        STRETCH  IN  OUT  TABLE=(i1,o1,i2,o2,i3,o3,..,iN,oN)

N pairs of DN values (real).  The TABLE defines a piece-wise linear transform
where the input DN values i1, i2, i3, ..., iN are mapped to the output DN
values o1, o2, o3, ..., oN, respectively, and the intervening DN values are
computed via linear interpolation.  Note that i1 < i2 < i3 < ...< iN whe N<=100.

All DN values outside the range in1 to inN normally remain unchanged.
However, if the parameter BACKGND is specified, these out-of-range DNs are
set to the BACKGND value.
.VARIABLE ITABLE
        STRETCH  IN  OUT  ITABLE=(i1,o1,i2,o2,i3,o3,..,iN,oN)

N pairs of integers.  Input DN values i1, i2, i3,...,iN are set equal to
output DN values o1, o2, o3,...,oN, respectively.  Note N<=100.
All other DN values remain unchanged unless the BACKGND parameter is specified.
.VARIABLE BACKGND
	BACKGND=m

Used with parameters CONTOUR, ALARM, ITABLE, and TABLE.  Specifies the output DN
value for all DNs not specified in the above parameters.  If BACKGND is not
specified, the corresponding pixels are copied from input to output unchanged.
.VARIABLE PEAK
		STRETCH  IN  OUT  'PEAK

Specifies a symmetrical linear stretch about the median DN of the image.  The
median is the DN with the maximum frequency in the image, and is determined
by locating the histogram peak.

A linear stretch is applied so that the median DN is mapped to mid-range in
the output (0.5*(DNMIN+DNMAX)).  The scale (slope) of the stretch is
determined in one of three ways:

If RANGE=n is specified, then lowdn=median-n/2 and hidn=median+n/2 are mapped
to DNMIN and DNMAX, respectively.

If FACTOR=s is specified, then the scale is s.

If neither RANGE or FACTOR are specified, then the scale is computed so as
to saturate PERCENT of the data (see PERCENT parameter).

See also parameters ASTRETCH, MEAN, RANGE, PEAK, DNMIN, DNMAX.
.VARIABLE MEAN
		STRETCH  IN  OUT  'MEAN

Specifies a symmetrical linear stretch about the mean DN of the image.  Since
the mean DN is determined from the histogram, all parameters effecting
histogram computations apply (e.g. AREA, INCLUDE, REXCLUDE).

A linear stretch is applied so that the mean DN is mapped to mid-range in
the output (0.5*(DNMIN+DNMAX)).  The scale (slope) of the stretch is
determined in one of three ways:

If RANGE=n is specified, then lowdn=mean-n/2 and hidn=mean+n/2 are mapped
to DNMIN and DNMAX, respectively.

If FACTOR=s is specified, then the scale is s.

If neither RANGE or FACTOR are specified, then the scale is computed so as
to saturate PERCENT of the data (see PERCENT parameter).

See also parameters ASTRETCH, RANGE, FACTOR, PEAK, DNMIN,DNMAX.

.VARIABLE RANGE
		STRETCH  IN  OUT  'PEAK  RANGE=n
		STRETCH  IN  OUT  'MEAN  RANGE=n

Causes the PEAK/MEAN stretch to saturate all but the specified DN interval
about the peak or mean DN.  I.e., this results in a linear transformation
where N-n maps to DNMIN and N+n maps to DNMAX, where N is the peak/mean DN.

Default is a linear transformation which saturates PERCENT of the data
symmetrically about the peak/mean DN.
.VARIABLE FACTOR
		STRETCH  IN  OUT  'PEAK  FACTOR=r
		STRETCH  IN  OUT  'MEAN  FACTOR=r

Specifies the slope term of the linear transformation defined by the peak/mean
DN.

Default is a linear transformation which saturates PERCENT of the data
symmetrically about the peak/mean DN.
.VARIABLE SMOOTH

	STRETCH  IN  OUT  'SMOOTH

This transformation causes the histogram of the output image to approximate a
uniform distribution (i.e. the output sample frequency is the same at every
DN level).  The transfer function is computed from the input histogram.

See also parameters DNMIN, DNMAX, REXCLUDE, IEXCLUDE, INCLUDE, CUT.

.VARIABLE GAUSS

	STRETCH  IN  OUT  'GAUSS  GSIGMA=s  GMEAN=m

This transformation causes the histogram of the output image to approximate a
Gaussian (or normal) distribution with a standard deviation of s DN and the
mean at m DN:

                    A                (i-m)**2
	h(i) = ------------ * e**( - -------- )
               s*sqrt(2*pi)            2s**2

where h(i) is the output sample frequency at DN i, and A is a scale term which
causes the total number of samples in the output histogram (area under the
curve) to be the same as the input histogram.

If GSIGMA is defaulted, s=3.  If GMEAN is defaulted, m=(DNMAX+DNMIN)/2.

For values of GSIGMA less than 1.0, the distribution will tend toward 
uniformity.

See also parameters DNMIN, DNMAX, REXCLUDE, IEXCLUDE, INCLUDE, CUT.

.VARIABLE GSIGMA

	GSIGMA=s		(real number)

Specifies the standard deviation in the Gaussian stretch.  See parameter
GAUSS for details.

.VARI GMEAN

	GMEAN=m			(real number)

Specifies the standard deviation in the Gaussian stretch.  See parameter
GAUSS for details.

.VARIABLE ELLIPSE

	STRETCH  IN  OUT  'ELLIPSE

This transformation causes the histogram of the output image to approximate the
the shape of the top half of an ellipse centered at the mid-DN level:

	h(x) = N*sqrt(a**2 - (x-a)**2)

where h(x) is the output sample frequency at x DN, a is both the center of the
ellipse and the size of the semi-major axis (h is 0 at x=a and x=2a and reaches
a maximum at x=a), and N is a scale term which causes the total number of
samples in the output histogram (area under the curve) to be the same as the
input histogram.  More exactly,

	a = (MAXDN-MINDN+1)/2

See parameters MAXDN, MINDN, REXCLUDE, IEXCLUDE, INCLUDE, CUT.

.VARIABLE POWER

		STRETCH  IN  OUT  POWER=r

This transformation causes the histogram of the output image to approximate the
the shape of the function:

		y = 1 - |x|**r

Let DNMIN=i1, DNMAX=i2.  The actual function is:

                                     i-i1
		h(i) = s*(1 - abs(2*------ - 1)**r)
                                    i2-i1

where h(i) is the sample frequency at output DN value i, and s is a scale term
which causes the total number of samples in the output histogram (area under
the curve) to be the same as the input histogram.  This causes a translation
and scaling of the x-axis (output DN) such that h(i1)=h(i2)=0 and the maximum
frequency occurs mid-way between this range.

See also parameters DNMIN, DNMAX, REXCLUDE, IEXCLUDE, INCLUDE, and CUT.

.VARIABLE BIMODAL
		BIMODAL=(o1,o2,o3,o4,o5,o6)

BIMODAL is intended to be applied to images with a bimodal histogram.  An
automatic linear stretch (see ASTRETCH option) is applied to the section of
the histogram surrounding each peak.

First, the two peaks are located.  If more than two peaks are located, the
histogram is progressively filtered to smooth the data.  If exactly two peaks
cannot be located, the program reverts to the ASTRETCH mode.

The minimum between the two peaks is then located.  This divides the histogram
into lower and upper pieces.  The auto-stretch algorithm is applied to both
pieces, resulting in stretch limits l1, h1 and l2, h2.  We have

		DNMIN < l1 < h1 <l2 <h2 < DNMAX

A piecewise linear transformation is applied such that DNMIN maps to o1,
l1 maps to o2, h1 maps to o3, l2 maps to o4, h2 maps to o5, and DNMAX maps to
o6.

The default (specified by BIMODAL=0) maps DNMIN to DNMIN, l1 to DNMIN, 
h1 to MIDDN, l2 to MIDDN+1, h2 to DNMAX, and DNMAX to DNMAX, where
MIDDN=(DNMIN+DNMAX)/2.
.VARIABLE REXCLUDE

		REXCLUDE=(m1,n1,m2,n2,m3,n3,...)

Up to 100 pairs of integers specifying DN ranges to exclude from the histogram.
All DN values within any of the specified ranges will have their frequencies
set to zero prior to using the histogram to compute the transfer function.

Overlapping DN ranges may be specified. You must have  DNMIN < mi < ni < DNMAX.
See also parameters INCLUDE, IEXCLUDE.

.VARIABLE IEXCLUDE

		IEXCLUDE=(n1,n2,n3,...)

Up to 100 integers specifying individual DN values to exclude from the
histogram.  All DN values specified will have their frequencies set to zero
prior to using the histogram to compute the transfer function.

See also parameters INCLUDE, REXCLUDE, CUT.

.VARIABLE INCLUDE

	KEYWORD:  'INCLUDE

'INCLUDE suppresses the default exclusion of 0 DN and max DN (255 for byte
data and 32767 for halfword data) from the histogram.

The reason that 0 DN and max DN are normally excluded is because these values
usually represent saturated samples (dark sky or overexposed image areas).
The various histogram stretch options perform best when these saturated samples
are excluded during computation of the transfer function.

In general, 'INCLUDE should be used for halfword images where 0 and negative
DNs represent valid image data.

See also parameters REXCLUDE, IEXCLUDE, CUT.

.VARIABLE CUT

		CUT=r		(0 <= r <= 100.)

Specifies a percentage of the maximum frequency count in the input image
histogram.  All DN values with a frequency count less than this pecentage of
the maximum frequency count will be excluded from the histogram (their
frequencies set to zero) prior to computation of the transfer function.
Default is r=0.

See also parametes REXCLUDE, IEXCLUDE, INCLUDE

.VARIABLE POST

		POST=(n1,n2)

A linear post stretch is performed following the initial stretch. The initial
stretch will map the input DN values to the range DNMIN to DNMAX.  The post
stretch will be a linear transformation such that DNMIN maps to n1 and DNMAX
maps to n2, as in the following byte image example:

		STRETCH  A  C  'GAUSS  POST=(255,0)

Since DNMIN and DNMAX are defaulted, the gaussian stretch will map the input
DNs to the full byte range (0 to 255).  The post stretch will then perform a
linear stretch such that 0 DN maps to 255 and 255 maps to 0.  The above is
equivalent to:

		STRETCH  A  B  'GAUSS
		STRETCH  B  C  'COMP

.VARIABLE IHIST

	KEYWORD:  'IHIST	(valid for byte data only)

Prints the histogram of the input image. If SPIKES=n is specified, the display
is normalized so that the n+1st highest frequency is at full scale.
.VARIABLE OHIST

	KEYWORD:  'OHIST	(valid for byte data only)

Prints the histogram of the output image. If SPIKES=n is specified, the display
is normalized so that the n+1st highest frequency is at full scale.
.VARIABLE SPIKES

		SPIKES=n	(see keywords 'IHIST and 'OHIST)

This adjusts the frequency scale of the histogram so that the DN value with
the n+1st highest frequency will appear at full scale (the n higher frequencies
are saturated).  This scaling does not affect the frequency values printed with
the histogram, nor does it affect the operation of the program in generating
the output image.  (Default is SPIKES=3) 
.VARIABLE ICDF

	KEYWORD:  'CDF		(valid for byte data only)

Prints the Cumulative Distribution Function (CDF) of the input image, where
CDF(i) is the total number of pixels with DN values less than or equal to i.
The CDF is computed from the histogram of the input image as follows:
	                       i
	             CDF(i)=  SUM  HIST(j)	for i=0,1,2,3,...,n-1
			       j=0

where the histogram HIST has n grey levels.
.VARIABLE OCDF

	KEYWORD:  'OCDF		(valid for byte data only)

Prints the Cumulative Distribution Function (CDF) of the output image, where
CDF(i) is the total number of pixels with DN values less than or equal to i.
The CDF is computed from the histogram of the output image.
.VARIABLE AREA

	AREA=(sl,ss,nl,ns)

Four integers: (starting line,starting sample,number of lines,number of samples)
Defines the area of the input image used to calculate the histogram of the
input image.  For the histogram stretches, this histogram is used to compute
the transfer function.  However, the stretch is performed on the portion of the
image specified by the SIZE field.

If AREA is not specified, this area is the same as the SIZE field.  See also
parameter LINC.

.VARIABLE LINC

	LINC=n

Causes the histogram to be calculated from every nth line of the input image.
Default is LINC=1.  See also AREA parameter.
.END
