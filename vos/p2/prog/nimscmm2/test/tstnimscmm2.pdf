procedure
refgbl $echo
refgbl $syschar
body

!   This is a test file for NIMSCMM2

let _onfail="continue"
let $echo="yes"     

enable-log

ush ln -s g7jnfeap4101a.3.vic edr_file
ush ln -s n0389703400.3.vic udr_file
ush ln -s g7jnfeap4101a.aacs aacs_file
ush ln -s s980326b.bsp.dat spk_file
ush ln -s nims_ikernel_mab.dat ik_file
ush ln -s boom_obscuration.nim dbm_file
ush ln -s nims_solar.dat sol_file
ush ln -s nims98a_gs4_ref_g1_01.tab CAL_FILE
ush ln -s jup_sl9_ave.tab DARK_FILE

write " try the 2 basic types of projections, using the Testbed EDR"
write " generated by the NIMSMERGE2 test pdf ..."
write " (Note that the ObsTab gives the target as Jupiter, while the"
write " simulated pointing is for Ganymede -- hence the warning message)"
write " "
write " first, POV (uses PPROJ):"
write " "
NIMSCMM2 edr=edr_file +
        cube=G7JNFEAP4101A.cub 'NOCAL +
        wtfil=wtfil  +
        aacsfil=aacs_file  +
        calfil=CAL_FILE +
	spkernel=spk_file +
        ikernel=ik_file solfile=sol_file +
	dbmfile=dbm_file +
        prodnote="testbed EDR with simulated pointing"  +
        obsnote="testbed EDR with simulated pointing"  +
        target=GANYMEDE phase=GANYMEDE_7_ENCOUNTER +
        proj=pov slew_tol=-1. +
	outsiz=(9,5)

label-list G7JNFEAP4101A.cub 'nousrtim
list G7JNFEAP4101A.cub nb=1  'nousrtim

write " "
write " next, any other projection that uses TRANV:"
write " "
NIMSCMM2 edr=edr_file +
        cube=G7JNFEAP4101A_1.cub 'NOCAL  +
        wtfil=wtfil  +
        aacsfil=aacs_file  +
        calfil=CAL_FILE +
	spkernel=spk_file +
        ikernel=ik_file solfile=sol_file +
	dbmfile=dbm_file +
        prodnote="testbed EDR with simulated pointing"  +
        obsnote="testbed EDR with simulated pointing"  +
        target=GANYMEDE phase=GANYMEDE_7_ENCOUNTER +
        proj=ORTHO slew_tol=-1.

label-list G7JNFEAP4101A_1.cub  'nousrtim
list G7JNFEAP4101A_1.cub nb=1  'nousrtim

write " "
write " test that NIMSCMM2 can also accept UDR input:"
write " "
NIMSCMM2 edr=udr_file +
        cube=G7JNFEAP4101A_2.cub 'NOCAL  +
        wtfil=wtfil  +
        aacsfil=aacs_file  +
        calfil=CAL_FILE +
	spkernel=spk_file +
        ikernel=ik_file solfile=sol_file +
	dbmfile=dbm_file +
        prodnote="testbed EDR with simulated pointing"  +
        obsnote="testbed EDR with simulated pointing"  +
        target=GANYMEDE phase=GANYMEDE_7_ENCOUNTER +
        proj=ORTHO slew_tol=-1.

write " "
write " test Tube option:"
write " "
NIMSCMM2 edr=edr_file +
        cube=G7JNFEAP4101A.tub 'tube 'NOCAL +
        wtfil=wtfil  +
        aacsfil=aacs_file  +
        calfil=CAL_FILE +
	spkernel=spk_file +
        ikernel=ik_file solfile=sol_file +
	dbmfile=dbm_file +
        prodnote="testbed EDR with simulated pointing"  +
        obsnote="testbed EDR with simulated pointing"  +
        target=GANYMEDE phase=GANYMEDE_7_ENCOUNTER +
        proj=ORTHO slew_tol=-1.

label-list G7JNFEAP4101A.tub  'nousrtim
list G7JNFEAP4101A.tub nb=1 nl=10  'nousrtim

write " "
write " now a test using the calibration files:"
write " "
NIMSCMM2 edr=edr_file +
        cube=G7JNFEAP4101A_3.cub +
        wtfil=wtfil  +
        aacsfil=aacs_file  +
        calfil=CAL_FILE +
	spkernel=spk_file +
	darkfil=DARK_FILE +
        ikernel=ik_file solfile=sol_file +
	dbmfile=dbm_file +
        prodnote="testbed EDR with simulated pointing"  +
        obsnote="testbed EDR with simulated pointing"  +
        target=GANYMEDE phase=GANYMEDE_7_ENCOUNTER +
        proj=pov slew_tol=-1. +
	outsiz=(9,5)

label-list G7JNFEAP4101A_3.cub  'nousrtim
list G7JNFEAP4101A_3.cub nb=1  'nousrtim

! THIS CATALOG TEST DOESN'T WORK, AND IT HAS BEEN DISABLED SINCE
! NIMSCMM2 IS NOW SCIENCE ONLY, NOT SYSTEMATIC, AFTER GLL PROJECT
! HAS TERMINATED
! (code is retained as comments for future reference)

!write " "
!write " now test the catalog interface:"
!write " "
!
!! first clean up from any previous tests:
!dcl isql/username="&user" /server_name="&server" /password="&password" /input=nimscmm2_rm.isql
!
!NIMSCMM2 edr=edr_file +
!        cube=G7JNFEAP4101A_4.cub 'NOCAL  +
!        wtfil=wtfil  +
!        aacsfil=aacs_file  +
!        calfil=CAL_FILE +
!        ikernel=ik_file solfile=sol_file +
!	dbmfile=dbm_file +
!        prodnote="testbed EDR with simulated pointing"  +
!        obsnote="testbed EDR with simulated pointing"  +
!        target=GANYMEDE phase=GANYMEDE_7_ENCOUNTER +
!        proj=ORTHO slew_tol=-1. +
!        catusr="&user" catpw="&password" 'CATUPDT
!
!! print out what we put in the catalog:
!dcl isql/username="&user"/server_name="&server"/password="&password"/input=nimscmm2_prnt.isql
!
!! clean up this test:
!dcl isql/username="&user"/server_name="&server"/password="&password"/input=nimscmm2_rm.isql

! this test makes use of the current MIPL configuration and is an
! example of a realistic cube-generation run:

nimscmm2 edr=(/project/test_work/testdata/gll/g7gnglobal01a.11 +
	/project/test_work/testdata/gll/g7gnglobal01d.4 +
	/project/test_work/testdata/gll/g7gnglobal01b.11 +
	/project/test_work/testdata/gll/g7gnglobal01e.4 +
	/project/test_work/testdata/gll/g7gnglobal01c.11 +
	/project/test_work/testdata/gll/g7gnglobal01f.4) +
	cube=g7gnglobal01a_lwk15.cub +
	sclk=(389887000 389889760) +
	'spice pckernel=/project/test_work/testdata/gll/ckg07a2h.plt +
	spkernel=/project/test_work/testdata/gll/s980127a.bsp +
	calfil=/project/test_work/testdata/gll/nims98a_gs3_ref_g1_01.cal +
	darkfil=/project/test_work/testdata/gll/nims98a_gs3_ref_id_01.drk +
	solfil=/project/test_work/testdata/gll/nims_solar.dat +
	ikernel=/project/test_work/testdata/gll/nims_ikernel_mab3.dat  +
	dbmfile=/project/test_work/testdata/gll/boom_obscuration2.nim  +
	prodnote="Predict pointing, offset from limb fit" +
	obsnote="GANYMEDE Global mosaic" +
	target=GANYMEDE phase=GANYMEDE_7_ENCOUNTER +
	proj=pov scale=0.5 'footp radfact=10 +
	pdist=199248.6 north=178.08 oaxis=(62,30) +
	tielat=0.46 tielon=346.12 tielin=61 tiesam=15 +
	dpoint=(0.0133 -0.00077)	! Del(C,X) = +50,+5 pix.

ush rm edr_file
ush rm udr_file
ush rm aacs_file
ush chmod 777 spk_file
ush rm spk_file
ush rm ik_file
ush rm dbm_file
ush rm sol_file
ush rm CAL_FILE
ush rm DARK_FILE

nimscmm2 edr=/project/test_work/testdata/gll/c9cnskuld_01a.9  +
 cube=c9cnskuld_01a.cub  +
 cocube=c9cnskuld_01a.coc  +
 sclk=(401506100 401507076)  +
 aacsfile=/project/test_work/testdata/gll/c9cnskuld_01.aacs  +
 slew_tol=-1  +
 spkernel=/project/test_work/testdata/gll/s980127a.bsp  +
 calfil=/project/test_work/testdata/gll/nims98a_gs4_ref_g1_01.cal  +
 PSHIFT=-1.00  +
 darkfil=/project/test_work/testdata/gll/nims98a_gs4_ref_g1_02.drk  +
 solfil=/project/test_work/testdata/gll/nims_solar.dat  +
 ikernel=/project/test_work/testdata/gll/nims_ikernel_mab5.dat  +
 dbmfile=/project/test_work/testdata/gll/boom_obscuration1.nim  +
 prodnote="orthographic projection"  +
 obsnote="Callisto observation"  +
 target=CALLISTO phase=CALLISTO_9_ENCOUNTER  +
 proj=ortho scale=5.026 'footp

ush rm G7JNFEAP4101A.COC
ush rm G7JNFEAP4101A.COT
ush rm G7JNFEAP4101A.cub
ush rm G7JNFEAP4101A.tub
ush rm G7JNFEAP4101A_1.COC
ush rm G7JNFEAP4101A_1.cub
ush rm G7JNFEAP4101A_2.COC
ush rm G7JNFEAP4101A_2.cub
ush rm G7JNFEAP4101A_3.COC
ush rm G7JNFEAP4101A_3.cub
ush rm WTFIL
ush rm c9cnskuld_01a.coc
ush rm c9cnskuld_01a.cub
ush rm g7gnglobal01a_lwk15.COC
ush rm g7gnglobal01a_lwk15.cub
ush rm wtfil

disable-log

end-proc
