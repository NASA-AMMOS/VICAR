procedure
refgbl $echo
refgbl $syschar
body

!   This is a test file for NIMSCMM2

let _onfail="continue"
let $echo="yes"     

enable-log

ush cp /project/test_work/testdata/gll/g7jnfeap4101a.3 edr_file
ush cp /project/test_work/testdata/gll/n0389703400.3 udr_file
ush cp /project/test_work/testdata/gll/g7jnfeap4101a.aacs aacs_file
ush cp /project/spice/ops/sun-solr/s980326b.bsp spk_file
ush cp /project/test_work/testdata/gll/nims_ikernel_mab.dat ik_file
ush cp /project/test_work/testdata/gll/boom_obscuration.nim dbm_file
ush cp /project/test_work/testdata/gll/nims_solar.dat sol_file
ush cp /project/test_work/testdata/gll/nims98a_gs4_ref_g1_01.tab CAL_FILE
ush cp /project/test_work/testdata/gll/jup_sl9_ave.tab DARK_FILE

write " try the 2 basic types of projections, using the Testbed EDR"
write " generated by the NIMSMERGE2 test pdf ..."
write " (Note that the ObsTab gives the target as Jupiter, while the"
write " simulated pointing is for Ganymede -- hence the warning message)"
write " "
write " first, POV (uses PPROJ):"
write " "
NIMSCMM2 edr=edr_file +
        cube=G7JNFEAP4101A.cub 'NOCAL +
        wtfil=wtfil  +
        aacsfil=aacs_file  +
        calfil=CAL_FILE +
	spkernel=spk_file +
        ikernel=ik_file solfile=sol_file +
	dbmfile=dbm_file +
        prodnote="testbed EDR with simulated pointing"  +
        obsnote="testbed EDR with simulated pointing"  +
        target=GANYMEDE phase=GANYMEDE_7_ENCOUNTER +
        proj=pov slew_tol=-1. +
	outsiz=(9,5)

label-list G7JNFEAP4101A.cub
list G7JNFEAP4101A.cub nb=1

write " "
write " next, any other projection that uses TRANV:"
write " "
NIMSCMM2 edr=edr_file +
        cube=G7JNFEAP4101A_1.cub 'NOCAL  +
        wtfil=wtfil  +
        aacsfil=aacs_file  +
        calfil=CAL_FILE +
	spkernel=spk_file +
        ikernel=ik_file solfile=sol_file +
	dbmfile=dbm_file +
        prodnote="testbed EDR with simulated pointing"  +
        obsnote="testbed EDR with simulated pointing"  +
        target=GANYMEDE phase=GANYMEDE_7_ENCOUNTER +
        proj=ORTHO slew_tol=-1.

label-list G7JNFEAP4101A_1.cub
list G7JNFEAP4101A_1.cub nb=1

write " "
write " test that NIMSCMM2 can also accept UDR input:"
write " "
NIMSCMM2 edr=udr_file +
        cube=G7JNFEAP4101A_2.cub 'NOCAL  +
        wtfil=wtfil  +
        aacsfil=aacs_file  +
        calfil=CAL_FILE +
	spkernel=spk_file +
        ikernel=ik_file solfile=sol_file +
	dbmfile=dbm_file +
        prodnote="testbed EDR with simulated pointing"  +
        obsnote="testbed EDR with simulated pointing"  +
        target=GANYMEDE phase=GANYMEDE_7_ENCOUNTER +
        proj=ORTHO slew_tol=-1.

write " "
write " test Tube option:"
write " "
NIMSCMM2 edr=edr_file +
        cube=G7JNFEAP4101A.tub 'tube 'NOCAL +
        wtfil=wtfil  +
        aacsfil=aacs_file  +
        calfil=CAL_FILE +
	spkernel=spk_file +
        ikernel=ik_file solfile=sol_file +
	dbmfile=dbm_file +
        prodnote="testbed EDR with simulated pointing"  +
        obsnote="testbed EDR with simulated pointing"  +
        target=GANYMEDE phase=GANYMEDE_7_ENCOUNTER +
        proj=ORTHO slew_tol=-1.

label-list G7JNFEAP4101A.tub
list G7JNFEAP4101A.tub nb=1 nl=10

write " "
write " now a test using the calibration files:"
write " "
NIMSCMM2 edr=edr_file +
        cube=G7JNFEAP4101A_3.cub +
        wtfil=wtfil  +
        aacsfil=aacs_file  +
        calfil=CAL_FILE +
	spkernel=spk_file +
	darkfil=DARK_FILE +
        ikernel=ik_file solfile=sol_file +
	dbmfile=dbm_file +
        prodnote="testbed EDR with simulated pointing"  +
        obsnote="testbed EDR with simulated pointing"  +
        target=GANYMEDE phase=GANYMEDE_7_ENCOUNTER +
        proj=pov slew_tol=-1. +
	outsiz=(9,5)

label-list G7JNFEAP4101A_3.cub
list G7JNFEAP4101A_3.cub nb=1

! THIS CATALOG TEST DOESN'T WORK, AND IT HAS BEEN DISABLED SINCE
! NIMSCMM2 IS NOW SCIENCE ONLY, NOT SYSTEMATIC, AFTER GLL PROJECT
! HAS TERMINATED
! (code is retained as comments for future reference)

!write " "
!write " now test the catalog interface:"
!write " "
!
!! first clean up from any previous tests:
!dcl isql/username="&user" /server_name="&server" /password="&password" /input=nimscmm2_rm.isql
!
!NIMSCMM2 edr=edr_file +
!        cube=G7JNFEAP4101A_4.cub 'NOCAL  +
!        wtfil=wtfil  +
!        aacsfil=aacs_file  +
!        calfil=CAL_FILE +
!        ikernel=ik_file solfile=sol_file +
!	dbmfile=dbm_file +
!        prodnote="testbed EDR with simulated pointing"  +
!        obsnote="testbed EDR with simulated pointing"  +
!        target=GANYMEDE phase=GANYMEDE_7_ENCOUNTER +
!        proj=ORTHO slew_tol=-1. +
!        catusr="&user" catpw="&password" 'CATUPDT
!
!! print out what we put in the catalog:
!dcl isql/username="&user"/server_name="&server"/password="&password"/input=nimscmm2_prnt.isql
!
!! clean up this test:
!dcl isql/username="&user"/server_name="&server"/password="&password"/input=nimscmm2_rm.isql

! this test makes use of the current MIPL configuration and is an
! example of a realistic cube-generation run:

nimscmm2 edr=(/project/gll/nims/edr/pb/g7gnglobal01a.11 +
	/project/gll/nims/edr/pb/g7gnglobal01d.4 +
	/project/gll/nims/edr/pb/g7gnglobal01b.11 +
	/project/gll/nims/edr/pb/g7gnglobal01e.4 +
	/project/gll/nims/edr/pb/g7gnglobal01c.11 +
	/project/gll/nims/edr/pb/g7gnglobal01f.4) +
	cube=g7gnglobal01a_lwk15.cub +
	sclk=(389887000 389889760) +
	'spice pckernel=/project/spice/ops/sun-solr/ckg07a2h.plt +
	spkernel=/project/spice/ops/sun-solr/s980127a.bsp +
	calfil=/project/gll/nims/cal/nims98a_gs3_ref_g1_01.cal +
	darkfil=/project/gll/nims/dark/nims98a_gs3_ref_id_01.drk +
	solfil=/project/gll/nims/misc/nims_solar.dat +
	ikernel=/project/gll/nims/misc/nims_ikernel_mab3.dat  +
	dbmfile=/project/gll/nims/misc/boom_obscuration.nim  +
	prodnote="Predict pointing, offset from limb fit" +
	obsnote="GANYMEDE Global mosaic" +
	target=GANYMEDE phase=GANYMEDE_7_ENCOUNTER +
	proj=pov scale=0.5 'footp radfact=10 +
	pdist=199248.6 north=178.08 oaxis=(62,30) +
	tielat=0.46 tielon=346.12 tielin=61 tiesam=15 +
	dpoint=(0.0133 -0.00077)	! Del(C,X) = +50,+5 pix.

ush rm edr_file
ush rm udr_file
ush rm aacs_file
ush chmod 777 spk_file
ush rm spk_file
ush rm ik_file
ush rm dbm_file
ush rm sol_file
ush rm CAL_FILE
ush rm DARK_FILE

disable-log

end-proc
