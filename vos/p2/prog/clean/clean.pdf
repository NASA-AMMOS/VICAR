process help=*
PARM INP TYPE=STRING COUNT=(2:3)
PARM OUT TYPE=STRING COUNT=3
PARM GAIN TYPE=REAL COUNT=(0:1) DEFAULT=0.2
PARM NOISE TYPE=REAL COUNT=(0:1) DEFAULT=2.0
PARM CHANGE TYPE=REAL COUNT=(0:1) DEFAULT=4.0
PARM ITER TYPE=INTEGER COUNT=(0:1) DEFAULT=1000000
PARM MAXMOD TYPE=INTEGER COUNT=(0:1) DEFAULT=200
PARM MODE TYPE=KEYWORD COUNT=(0:1) VALID=(TOTAL,POSITIVE) DEFAULT=TOTAL
PARM CONVOLVE TYPE=KEYWORD COUNT=(0:1) VALID=(CONVOLVE,NONE) DEFAULT=NONE
END-PROC

.TITLE
VICAR program CLEAN

.HELP
PURPOSE:
To implement the "clean" algorithm, where a point spread function is
iteratively removed from an image in order to deconvolve it.

EXECUTION:
clean inp=(blurredimage,psf) out=(restored,residual,convolved) mode=...

where:
blurredimage   Is the image convolved with the point spread function.
psf            Is the point spread function.
restored       Is an image which when convolved by psf will be similar to 
               blurredimage. It will not resemble the scene before
               convolution however.
residual       Is the remaining data after many psf subtractions.
convolved      Is "restored" convolved by psf. Should closely resemble
               "blurredimage". 

NOTE: psf must be odd in size and the max pixel must be at the center.

METHOD:
see   http://www.astro.virginia.edu/~eww6n/math/CLEANAlgorithm.html

Clean computes an image which, when convolved by psf, produces the input
blurred image. It does this by iteratively subtracting the psf until
nothing is left, just noise. Clean can be used to study the structure of
small abjects, to permit psf changes, and to make maps of artifact
inconsistent with the psf (which cannot be modelled as superpositions
of psf's).

Note: The restored image will not resemble the true image before convolution
with the point spread function. It is merely a possible such image.
The rms nearest image is generated by program WIENER.
The most likely image is generated by program MEM.

HISTORY:
9-1-98  J Lorre. 
COGNIZANT PROGRAMMER:  Jean Lorre

.LEVEL1
.VARI INP
1. blurred image.
2. point spread function.

.VARI OUT
1. delta function image.
2. residual image
3. convolved restored image

.VARI GAIN
algorithm gain.

.VARI NOISE
Standard deviation
 of the noise.

.VARI ITER
Number of iterations.

.VARI CHANGE
Limiting change in
residual

.VARI MAXMOD
Max number of changes
per pixel.

.VARI MODE
Operation mode:
TOTAL or POSITIVE

.VARI CONVOLVE
Convolves the input image

.LEVEL2
.VARI INP
1. blurred image.
2. point spread function.

.VARI OUT
1. delta function image.
2. residual image (input after psf removals).
3. delta function image convolved with psf.

.VARI GAIN
algorithm gain. Each time a point spread function is subtracted from the
image the amplitude of the psf is set to GAIN* the DN of the pixel.
Default is 0.2
Large point spread functions should have smaller gains.

.VARI NOISE
Standard deviation of the noise.
Iterations will cease when the residual falls below NOISE.
Defaults to 2.0
This test usually stops the algorithm in the case MODE=POSITIVE.

.VARI ITER
Maximum permitted umber of iterations.
Defaults to 1,000,000

.VARI CHANGE
Iterations will cease when the percent reduction in the residual becomes 
less than CHANGE.
Defaults to 4.0
This test usually stops the algorithm in the case MODE=TOTAL

.VARI MAXMOD
The maximum number of times a pixel can be modified. This keeps clean
from cycling between a small set of pixels comprising artifact
which cannot be subracted as point spread functions.
Defaults to 200

.VARI MODE
The mode of operation.
There are two modes:

TOTAL where the point spread function can be positive or negative.
This mode will match the input image very well but will create negative
intensities in the restored image.

POSITIVE where the point spread function can only be positive.
This mode will not match the input image very well but will create
positive intensities in the restored image.

Default is TOTAL.

.VARI CONVOLVE
Causes the input image to be convolved with the point spread function
before any other operations. The default is for the first input to be
convolved already.
