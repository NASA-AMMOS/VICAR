PROCESS HELP=*
PARM INP (STRING,32) COUNT=(1:3)
PARM OUT (STRING,32) COUNT=(1:3)
PARM MODE KEYWORD VALID=(CPIC,TRANSFORM) DEFAULT=TRANSFORM
PARM L_DISP KEYWORD VALID=(L_AMPL,L_PHASE,L_COSINE,L_SINE,L_INTENS, +
  L_REAL,L_IMAG) DEFAULT=L_AMPL
PARM R_DISP KEYWORD VALID=(R_AMPL,R_PHASE,R_COSINE,R_SINE,R_INTENS, +
  R_REAL,R_IMAG) DEFAULT=R_AMPL
PARM SCALING KEYWORD VALID=(LOG,LINEAR)  DEFAULT=LINEAR
PARM ORIGIN REAL COUNT=2 DEFAULT=(1.,1.)
PARM NMIN REAL DEFAULT=0.1
PARM NMAX REAL DEFAULT=0.1
PARM SIGN KEYWORD VALID=SIGN COUNT=(0:1) DEFAULT=--
PARM THRESHOL REAL DEFAULT=1.0
END-PROC
!
.TITLE
Program "fftpic"
.HELP
PURPOSE:

"fftpic" processes input VICAR formatted complex fourier transformations
or complex pictures, extracting, reorganizing, and automatically scaling
various functions of the complex data for image display. Functions of 
the complex input that may be displayed include: amplitude, intensity 
(squared amplitude), phase (with or without sign), real part, and 
imaginary part. Linear or logarithmic scaling prior to output exists for 
all functions except phase.

NOTE: The input transform format is assumed to be that produced by VICAR
program FFT22.  See HELP FFT22 for more details.
.page 
EXECUTION:
               fftpic  IN  OUT  PARAMS
 where:

 IN denotes 1-3 input files: a primary input and one or two scratch files.
 
 OUT denotes 1-3 output files: the primary output and one or two scratch
  files.

  (Note that the scratch files may be specified as EITHER input OR
  output files, but not both.  TRANSFORM mode requires two scratch
  files, CPIC mode requires one.  See OPERATION, below.)
 
 PARAMS includes other available parameters, viz.:
 
MODE   SCALING   L_DISP   R_DISP   ORIGIN   NMIN    NMAX   SIGN   THRESHOL

Each is explained in their respective parameter section. (Use TUTOR mode.)
.page
OPERATION:

It is assumed the input data set is a complex*8 matrix with a standard 
Vicar2 label.  The picture size to be processed is derived from the system 
label, so no size field is allowed. The output system label is automatically
updated based on operating mode and input size information.  The output
file is a byte image suitable for display.  (It is referred to as the
"Display" in the following text.)

"fftpic" operates in two modes: the "Transform" mode and the "Complex Picture"
(CPIC) mode.  These are explained below.

In the TRANSFORM display mode, the data are assumed to be organized as 
described in the 'FFT22' Help text.  However the user should be aware that
the FT generated by FFT22, is transposed with respect to normal usage.
In this mode, the image is rearranged so that the DC term (the [0,0] 
frequency) is at the center of the display.  In this mode, the redundant 
frequencies on the positive and negative X-axis are replicated for clarity, 
so the display contains one or two (depending on display types requested) 
more samples than does the input.

In the COMPLEX PICTURE mode, the display has the same size (in samples) 
and structure as does the input.

Depending on the mode specified, the complex input data are first processed
into one (Complex Picture mode) or two (Transform mode) intermediate data 
sets.  During this processing the specified display function(s) of the 
complex input is (are) generated, scaled, and stored as real*4 data. In 
the Complex Picture mode the entire input is processed uniformly into one 
intermediate data set. Hence, only one scratch file is required. 
On the other hand, in the Transform mode the input conjugate symmetry is 
used to divide the display into two halves which may have display types 
specified independently. Hence two scratch files are required. In the 
Transform mode only the left half plus one samples are processed.

In order to efficiently scale and pack the resulting data into byte format, 
a histogram (which may be logarithmic) is accumulated for the entire input.
Then the histogram is analyzed to determine a linear transformation on the
intermediate data for packing into the output. For phase information displays,
the packing transformation is predefined between -PI and +PI or 0 and + PI 
depending on whether or not 'SIGN' has been specified, respectively.

If the two halves of the transform display are in the same mode, the output
display exhibits conjugate central symmetry with spatial frequency. DC (i.e.
(0,0) spatial frequency) is located at line (NY/2 + 1) and sample (NX/2 + 1).
Positive and negative horizontal spatial frequency components are positioned
to the right and left of this point, respectively, along a horizontal axis
similarly, positive and negative vertical frequency components are located
above and below this point along a vertical axis.

NOTE:  the user should be aware that the vertical dimension is reversed
with respect to normal image processing convention:  the positive Y-axis
is upward, whereas for an image the increasing LINE dimension is downward.

If the two halves are in different modes, the display is organized by spatial
frequency components symmetrically about the vertical line with sample coor-
dinate (NX/2 + 1.5).  Therefore, DC for the right half is at line (NY/2 + 1)
and sample (NX/2 + 2), while DC for the left half is at line (NY/2 + 1) and
sample (NX/2 + 1).  Positive and negative vertical spatial frequencies are 
located above and below these DC points, respectively, for each half of
the display along vertical axis.  Positive horizontal spatial frequency
increases to the right for the right hand display and to the left for the left
hand display along a horizontal spatial frequency components are not explicit-
ly displayed in this case.  The scaling applied to both halves is the same
(determined from the composite histogram) except if one half is phase and the
other is amplitude (or another non-phase display).  In this case the predefined
phase scaling is used on the appropriate half and that derived from the
histogram on the other.
.page
SCRATCH DATASETS:

These may be specified either as input files or as output files, but not
both.  The reason for this feature is that the initial version of FFTPIC
required that they be pre-allocated with the correct size, and hence were
input files.  Currently, Vicar2 allows run-time determination of file
size, so the scratch files are created by the program and were therefore
made output files.  However, for consistency with existing user practice
the option of input scratch files was retained.  In no case do they need
to be pre-allocated.
.page
EXAMPLE:
 
        gen A 256 256
        fft22 A (B,SCR)
        fftpic C (OUT,X1,X2) 'L_AMPL 'R_PHASE 'LOG 'SIGN +
          THRES=.01 NMIN=5.0 NMAX=7.0 ORIGIN=(6,8)
 
The input to this example is a 256 by 256 sample (2048 bytes) transform. 
The default display mode (TRANSFORM) is used. The output display matrix 
consists of a logarithmic amplitude display (left half) and a linear 
phase display with the sign of the angle preserved (right half). A 
multiplication of 1/.01 is performed prior to clipping results less than 
1.0 in absolute value (i.e output = 100*input). The phase origin location 
will be at line 8 and sample 6. Finally, 5 percent of the non-phase 
information portion of the display will be saturated black (DN=0) and 7 
percent will be saturated white (DN=255).

TIMING:
	NONE AVAILABLE FOR THE VAX

WRITTEN BY:  T. C. RINDFLEISCH		  NOVEMBER 22, 1971
CONVERTED TO VAX BY:  Helen De Rueda      DECEMBER 19, 1983
CONVERTED TO VICAR2 BY:  L. W. Kamp       5 FEB 1985
Made portable for UNIX by: A. Scop (CRI)  5 SEP 1994
Bug fixes:  L. W. Kamp                    12 FEB 2010
CURRENT COGNIZANT PROGRAMMER:  L. W. Kamp
.LEVEL1
.VARI INP
Input image, plus 1 or
2 intermediate files.
.VARI OUT
Output image, plus 1 or
2 intermediate files.
.VARI SCALING
KEYWORD. Histogram scaling.
Valid: LOG,LINEAR
.VARI L_DISP
KEYWORD: Left display type.
Valid: L_AMPL,L_PHASE,L_COSINE,
L_SINE,L_INTENS,L_REAL,L_IMAG
.VARI R_DISP
KEYWORD: Right display type.
Valid: R_AMPL,R_PHASE,R_COSINE,
R_SINE,R_INTENS,R_REAL,R_IMAG
.VARI ORIGIN
Coordinates of phase origin.
.VARI NMIN
Fraction of non-phase portion
of display to be saturated
to black.
.VARI NMAX
Fraction of non-phase portion
of display to be saturated to
white.
.VARI MODE
KEYWORD: operating mode.
Valid: TRANSFORM,CPIC
.VARI SIGN
Sign of angle.
.VARI THRESHOL
Threshold used to scale
display information.
.LEVEL2
.VARI INP
This specifies the input image, plus 1 or 2 intermediate (scratch) 
datasets used during the processing.  The scratch datasets may be 
specified as input files or as output files. (But not both.) The
scratch files are always created by the program, hence do not need
to be pre-allocated by the user.

In TRANSFORM mode, the primary input is assumed to be a complex
Fourier-transform image in the format produced by program FFT22.
In CPIC mode, the primary input may be any complex image 
(or a real image with even number of samples).
 
The sizes of the intermediate files will be equal to the input in samples,
but will of format REAL.
 
If the keyword 'CPIC' has been specified, then only one scratch file is 
required.  Two scratch files are required for TRANSFORM mode.
.VARI OUT
This specifies the output image, plus 1 or 2 intermediate (scratch) 
datasets used during the processing.  The scratch datasets may be 
specified as input files or as output files. (But not both.)
 
The size of the primary output will be depend on MODE: in TRANSFORM mode
it will be larger than the input in samples by 1 (if L_DISP is the same
as R_DISP) or 2 (if L_DISP and R_DISP are different) samples;  in CPIC
mode it will have the same number of samples.  In all cases, the format 
will be BYTE and the number of lines will be that of the primary input.
 
The sizes of the intermediate files will be equal to the input in samples,
but will of format REAL.
 
If the keyword 'CPIC' has been specified, then only one scratch file is
required.
.VARI SCALING
This parameter has two valid keyword values: LINEAR and LOG.
 
LINEAR specifies linear scaling of the display information selected.
This is the default.
  
LOG specifies logarithmic (base 10) scaling of the display information
selected. This modifier applies only to non-phase portions of the requested
displays. 
.VARI L_DISP
This parameter has 7 valid keyword values: L_AMPL, L_PHASE, L_COSINE, L_SINE,
L_INTENS, L_REAL, L_IMAG.  It specifies the information displayed in the
left half of the primary output for TRANSFORM mode, or for the entire
output for Complex Picture (CPIC) mode.
 
  L_AMPL displays amplitude information. This is the default.
  L_PHASE displays phase information without sign.
  L_COSINE displays real-part information. Same as L_REAL.
  L_SINE displays imaginary-part information. Same as L_IMAG.
  L_INTENS displays intensity (squared amplitude) information.
  L_REAL displays real-part information. Same as L_COSINE.
  L_IMAG displays imaginary-part information. Same as L_SINE.
.VARI R_DISP
This parameter has 7 valid keyword values: R_AMPL, R_PHASE, R_COSINE, R_SINE,
R_INTENS, R_REAL, R_IMAG.  It specifies the information displayed in the
right half of the primary output for TRANSFORM mode ONLY.
 
This parameter is ignored for Complex Picture (CPIC) mode.
 
  R_AMPL displays amplitude information. This is the default.
  R_PHASE displays phase information without sign.
  R_COSINE displays real-part information. Same as R_REAL.
  R_SINE displays imaginary-part information. Same as R_IMAG.
  R_INTENS displays intensity (squared amplitude) information.
  R_REAL displays real-part information. Same as R_COSINE.
  R_IMAG displays imaginary-part information. Same as R_SINE.
.VARI ORIGIN
ORIGIN = (X,Y), where X and Y are floating point numbers specifying the 
sample and line coordinates of the requested phase origin location.
NOTE: (1,1) is the upper left hand corner. 
Default = (1,1)
.VARI NMIN
NMIN is a floating point number specifying the fraction of non-phase 
information portions of the display which will be saturated to black (0). 
Default = 0.1 (10 percent)
.VARI NMAX
NMAX is a floating point number specifying the fraction of non-phase 
information portions of the  display which will be saturated to 
white (255). 
Default = 0.1 (10 percent)
.VARI SIGN
SIGN specifies that the sign of the angle (-P<ANGLE<=P, where the value
of PI is to be preserved in scaling phase information for display. The
specification of SIGN applies to both left and right halves of the 'transform'
display if two display types are called for. Default is suppression of SIGN
information in the phase angle displays).
.VARI THRESHOL
THRESHOL=R4 where R4 is a floating point number specifying a threshold used to
scale display information prior to clipping results less than 1.0 in absolute
value. Default is 1.0.
.END
